<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Echo Echo Party - Wonder Heroes Academy</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#1a0533 0%,#2d1b69 35%,#4a1a8a 65%,#6b2fa0 100%);color:#fff;height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden;position:relative}

.disco{position:fixed;top:52px;left:50%;transform:translateX(-50%);width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff,#ccc 40%,#999);z-index:3;pointer-events:none;box-shadow:0 0 18px rgba(255,255,255,.2);animation:discR 3s linear infinite}
@keyframes discR{0%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(180deg) brightness(1.3)}100%{filter:hue-rotate(360deg) brightness(1)}}

.spot{position:fixed;top:60px;left:50%;width:3px;height:40vh;opacity:.1;pointer-events:none;z-index:2;transform-origin:top center;animation:spS var(--d,5s) ease-in-out infinite alternate}
@keyframes spS{0%{transform:rotate(var(--r1,-20deg))}100%{transform:rotate(var(--r2,20deg))}}

.floor{position:fixed;bottom:0;left:0;right:0;height:6%;background:linear-gradient(0deg,rgba(100,30,150,.5),transparent);pointer-events:none;z-index:1}

.m-note{position:fixed;z-index:3;pointer-events:none;font-size:18px;opacity:0;animation:nF var(--d,4s) ease-out forwards}
@keyframes nF{0%{transform:translateY(0) rotate(0);opacity:.6}100%{transform:translateY(-160px) rotate(25deg) translateX(var(--dx,15px));opacity:0}}

.top-bar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:6px 10px;z-index:100;position:relative;flex-shrink:0}
.btn-icon{width:40px;height:40px;border-radius:11px;border:2px solid rgba(255,255,255,.12);background:rgba(255,255,255,.07);color:#fff;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;text-decoration:none;transition:transform .15s;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.btn-icon:active{transform:scale(.88);background:rgba(255,255,255,.14)}
.top-mid{text-align:center}
.top-mid .sc{font-size:20px;font-weight:900;color:#ffd700;text-shadow:0 0 12px rgba(255,215,0,.45)}
.top-mid .lv{font-size:10px;color:rgba(255,255,255,.4)}

.lang-dd{position:absolute;top:50px;left:10px;background:rgba(30,10,60,.96);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.6);z-index:200;overflow:hidden;display:none;backdrop-filter:blur(8px)}
.lang-dd.show{display:block}
.lang-dd button{padding:11px 18px;font-size:14px;cursor:pointer;border:none;background:transparent;color:#fff;width:100%;text-align:left}
.lang-dd button:active{background:rgba(255,255,255,.08)}
.lang-dd button.sel{background:rgba(255,215,0,.12);color:#ffd700;font-weight:700}

.screen{display:none;width:100%;flex:1;flex-direction:column;align-items:center;overflow:hidden;min-height:0;z-index:10}
.screen.active{display:flex}

.start-screen{justify-content:center;gap:14px;text-align:center;padding:20px}
.g-title{font-size:24px;font-weight:900;background:linear-gradient(135deg,#ff6b6b,#ffd700,#48dbfb,#a55eea);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:gr 4s ease infinite;line-height:1.3}
@keyframes gr{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.g-sub{color:rgba(255,255,255,.65);font-size:13px;max-width:300px;line-height:1.55}
.big-icon{font-size:50px;animation:pB 1.5s ease-in-out infinite}
@keyframes pB{0%,100%{transform:translateY(0) rotate(-5deg)}25%{transform:translateY(-10px) rotate(5deg)}50%{transform:translateY(0) rotate(-3deg)}75%{transform:translateY(-6px) rotate(4deg)}}
.start-btn{padding:14px 32px;font-size:18px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#ff6b6b,#ffd700,#48dbfb);background-size:300% 300%;animation:gr 3s ease infinite;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3);box-shadow:0 0 24px rgba(255,100,100,.3);transition:transform .15s}
.start-btn:active{transform:scale(.93)}
.hint-tx{color:rgba(255,255,255,.28);font-size:11px;margin-top:2px}
.how-box{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 16px;max-width:300px;font-size:12px;color:rgba(255,255,255,.55);line-height:1.6;text-align:left}
.how-box b{color:#ffd700}

.game-content{flex:1;width:100%;display:flex;flex-direction:column;align-items:center;padding:4px 12px 4px;min-height:0;position:relative}
.timer-wrap{width:100%;height:5px;background:rgba(255,255,255,.06);border-radius:3px;flex-shrink:0;overflow:hidden}
.timer-bar{height:100%;border-radius:3px;background:linear-gradient(90deg,#ff6b6b,#ffd700,#48dbfb,#a55eea);background-size:300% 100%;animation:gr 2s ease infinite;width:100%}

.game-hud{width:100%;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;margin-top:3px}
.hud-item{font-size:12px;font-weight:700;background:rgba(255,255,255,.05);padding:2px 8px;border-radius:12px}
.hud-item .val{color:#ffd700}

.step-dots{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;max-width:260px;margin:4px 0;flex-shrink:0}
.s-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.08);transition:background .3s,transform .3s}
.s-dot.cur{background:rgba(255,255,255,.5);transform:scale(1.4)}
.s-dot.hit{background:#4ade80}.s-dot.miss{background:#fbbf24}.s-dot.wrong{background:#f87171}.s-dot.skip{background:rgba(255,255,255,.15)}

.history-row{display:flex;gap:14px;align-items:flex-end;flex-shrink:0;margin:5px 0 2px}
.hist-slot{display:flex;flex-direction:column;align-items:center;gap:2px}
.hist-label{font-size:9px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.5px;font-weight:700}
.hist-box{width:50px;height:50px;border-radius:12px;background:rgba(255,255,255,.04);border:2px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:26px;transition:all .35s ease}
.hist-box.pop{animation:hPop .35s ease}
@keyframes hPop{0%{transform:scale(.8)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

.compare-hint{font-size:9px;color:rgba(255,255,255,.2);margin:2px 0;flex-shrink:0;letter-spacing:.5px}

.stage-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:0;width:100%;position:relative}
.now-label{font-size:10px;color:rgba(255,255,255,.3);font-weight:700;letter-spacing:1px;margin-bottom:3px}
.emoji-stage{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.07),rgba(255,255,255,.01));border:3px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;position:relative;transition:border-color .3s,box-shadow .3s;animation:stPulse 2s ease-in-out infinite}
@keyframes stPulse{0%,100%{box-shadow:0 0 12px rgba(150,100,255,.08)}50%{box-shadow:0 0 28px rgba(150,100,255,.18)}}
.emoji-stage.st-correct{border-color:rgba(100,255,150,.5);box-shadow:0 0 35px rgba(100,255,150,.3)!important;animation:none}
.emoji-stage.st-wrong{border-color:rgba(255,100,100,.5);box-shadow:0 0 25px rgba(255,100,100,.25)!important;animation:none}
.emoji-stage.st-miss{border-color:rgba(255,200,50,.4);box-shadow:0 0 20px rgba(255,200,50,.2)!important;animation:none}
.emoji-inner{font-size:54px;line-height:1}
.emoji-inner.enter{animation:emIn .4s ease-out}
@keyframes emIn{0%{transform:scale(0) rotate(-30deg);opacity:0}60%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
.emoji-inner.dance{animation:emD .8s ease-in-out infinite}
@keyframes emD{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-6px) rotate(-8deg)}50%{transform:translateY(0) rotate(0)}75%{transform:translateY(-4px) rotate(8deg)}}
.emoji-inner.celebrate{animation:emC .8s ease}
@keyframes emC{0%{transform:scale(1) rotate(0)}20%{transform:scale(1.4) rotate(-15deg)}40%{transform:scale(1.3) rotate(15deg)}60%{transform:scale(1.35) rotate(-8deg)}80%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
.emoji-inner.shake{animation:emS .4s ease}
@keyframes emS{0%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}100%{transform:translateX(0)}}

.fb-area{height:30px;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;width:100%}
.feedback{position:absolute;font-size:17px;font-weight:900;opacity:0;white-space:nowrap;text-shadow:0 0 10px currentColor;pointer-events:none}
.feedback.show{opacity:1;animation:fbP .45s ease}
@keyframes fbP{0%{transform:scale(.5)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

.match-btn-wrap{width:100%;flex-shrink:0;display:flex;justify-content:center;padding:4px 0}
.match-btn{width:82%;max-width:300px;padding:15px;font-size:22px;font-weight:900;border:none;border-radius:18px;cursor:pointer;background:linear-gradient(135deg,#ff6b6b,#ff8e53);color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3);box-shadow:0 4px 18px rgba(255,100,100,.3);transition:transform .1s,box-shadow .1s;position:relative;overflow:hidden;letter-spacing:1px}
.match-btn:active:not(:disabled){transform:scale(.94)}
.match-btn:disabled{opacity:.3;transform:none!important}
.match-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 30%,rgba(255,255,255,.12) 50%,transparent 70%);background-size:200% 200%;animation:gr 2s ease infinite}

.party-crowd{width:100%;flex-shrink:0;height:36px;display:flex;align-items:flex-end;justify-content:center;gap:2px;overflow:hidden;padding:0 6px}
.crowd-m{font-size:19px;animation:cBo 1.1s ease-in-out infinite;animation-delay:var(--dl,0s)}
@keyframes cBo{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.crowd-m.cParty{animation:cPa .55s ease!important}
@keyframes cPa{0%{transform:translateY(0) scale(1)}30%{transform:translateY(-14px) scale(1.2) rotate(-12deg)}60%{transform:translateY(-8px) scale(1.15) rotate(10deg)}100%{transform:translateY(0) scale(1)}}

.confetti{position:fixed;z-index:200;pointer-events:none;animation:cF 1.4s ease-out forwards}
@keyframes cF{0%{transform:translateY(0) rotate(0) scale(1);opacity:1}100%{transform:translateY(55vh) rotate(720deg) scale(.05);opacity:0}}
.sparkle{position:fixed;z-index:55;font-size:14px;pointer-events:none;animation:spU .65s ease-out forwards}
@keyframes spU{0%{transform:translateY(0) scale(.3) rotate(0);opacity:1}100%{transform:translateY(-30px) scale(1) rotate(180deg);opacity:0}}

.combo-box{position:fixed;top:46px;left:50%;transform:translateX(-50%);font-size:16px;font-weight:900;color:#ffd700;text-shadow:0 0 14px rgba(255,215,0,.6);z-index:80;opacity:0;transition:opacity .3s;pointer-events:none}
.combo-box.show{opacity:1;animation:cbPo .35s ease}
@keyframes cbPo{0%{transform:translateX(-50%) scale(.5)}50%{transform:translateX(-50%) scale(1.3)}100%{transform:translateX(-50%) scale(1)}}

.round-overlay{position:fixed;inset:0;z-index:150;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(20,5,50,.9);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);gap:12px;text-align:center;padding:24px}
.round-overlay.show{display:flex}
.ro-title{font-size:26px;font-weight:900;color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,.5)}
.ro-sub{color:rgba(255,255,255,.6);font-size:14px;max-width:280px;line-height:1.5}
.ro-icon{font-size:44px;animation:pB 1.5s ease-in-out infinite}

.zipp{position:fixed;bottom:5px;left:8px;font-size:24px;z-index:80;pointer-events:none}
.zipp.zDance{animation:zD .6s ease}
@keyframes zD{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-15deg) scale(1.2)}50%{transform:rotate(15deg) scale(1.3)}75%{transform:rotate(-8deg) scale(1.15)}100%{transform:rotate(0) scale(1)}}
.z-bub{position:fixed;bottom:34px;left:6px;background:rgba(255,255,255,.92);color:#333;border-radius:11px;padding:4px 10px;font-size:11px;font-weight:700;max-width:125px;text-align:center;box-shadow:0 3px 14px rgba(0,0,0,.5);z-index:80;opacity:0;transition:opacity .3s;pointer-events:none}
.z-bub.show{opacity:1}
.z-bub::after{content:'';position:absolute;bottom:-6px;left:12px;border-left:5px solid transparent;border-right:5px solid transparent;border-top:7px solid rgba(255,255,255,.92)}

.end-screen{justify-content:center;gap:11px;text-align:center;padding:18px}
.end-title{font-size:24px;font-weight:900;background:linear-gradient(135deg,#ffd700,#ff6b6b,#48dbfb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.end-stats{color:rgba(255,255,255,.8);font-size:14px;line-height:2}
.end-stats .v{color:#ffd700;font-weight:700;font-size:18px}
.stars-row{font-size:30px;letter-spacing:4px}
.crowd-fin{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;font-size:22px;max-width:280px}
.crowd-fin span{animation:cfP .4s ease backwards}
@keyframes cfP{0%{transform:scale(0) rotate(-20deg)}100%{transform:scale(1) rotate(0)}}
.cf-lbl{width:100%;font-size:11px;color:rgba(255,255,255,.3);margin-bottom:2px}
.again-btn{padding:13px 30px;font-size:17px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#ffd700,#ff8e53);color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3);box-shadow:0 0 20px rgba(255,215,0,.2);transition:transform .15s}
.again-btn:active{transform:scale(.93)}

@media(max-height:600px){.big-icon{font-size:38px}.g-title{font-size:20px}.emoji-stage{width:88px;height:88px}.emoji-inner{font-size:42px}.hist-box{width:42px;height:42px;font-size:22px}.match-btn{padding:12px;font-size:19px}.party-crowd{height:30px}.crowd-m{font-size:16px}.step-dots{max-width:220px}.s-dot{width:6px;height:6px}.how-box{font-size:11px;padding:8px 12px}}
@media(min-height:750px){.emoji-stage{width:128px;height:128px}.emoji-inner{font-size:64px}.hist-box{width:56px;height:56px;font-size:30px}.match-btn{padding:18px;font-size:24px}}
</style>
</head>
<body>

<div class="disco"></div>
<div class="spot" style="background:linear-gradient(180deg,#ff6b6b88,transparent);--r1:-25deg;--r2:15deg;--d:5s"></div>
<div class="spot" style="background:linear-gradient(180deg,#48dbfb88,transparent);--r1:10deg;--r2:-28deg;--d:6.5s"></div>
<div class="spot" style="background:linear-gradient(180deg,#ffd70088,transparent);--r1:-15deg;--r2:22deg;--d:7s"></div>
<div class="spot" style="background:linear-gradient(180deg,#a55eea88,transparent);--r1:18deg;--r2:-18deg;--d:4.5s"></div>
<div class="floor"></div>

<div class="top-bar">
  <button class="btn-icon" id="langBtn">ğŸŒ</button>
  <div class="lang-dd" id="langDd">
    <button class="sel" id="lEN">ğŸ‡ºğŸ‡¸ English</button>
    <button id="lZH">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</button>
  </div>
  <div class="top-mid">
    <div class="sc" id="scV">0</div>
    <div class="lv" id="lvV">Round 1</div>
  </div>
  <a href="index.html" class="btn-icon">ğŸ </a>
</div>

<div class="screen start-screen active" id="scrS">
  <div class="big-icon">ğŸ‰ğŸ±ğŸ¶</div>
  <div class="g-title" id="txTitle">Echo Echo Party!</div>
  <div class="g-sub" id="txSub">Dancing animals are throwing a party! Tap MATCH when you see an echo â€” the same animal from 2 steps ago!</div>
  <div class="how-box" id="txHow">
    <b>How to play:</b><br>
    ğŸ± â†’ ğŸ¶ â†’ ğŸ± â† <b>MATCH!</b> (same as 2 ago)<br>
    ğŸµ â†’ ğŸ° â†’ ğŸ» â† No match (different)<br>
    Watch ğŸ‘€ Â· Remember ğŸ§  Â· Tap MATCH! ğŸ¯
  </div>
  <button class="start-btn" id="btnStart">ğŸµ Join the Party!</button>
  <div class="hint-tx" id="txHint">Tap when NOW = 2 steps ago!</div>
</div>

<div class="screen" id="scrG">
  <div class="game-content">
    <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
    <div class="game-hud">
      <div class="hud-item">âœ… <span class="val" id="hudHits">0</span></div>
      <div class="hud-item" id="hudRound">Round 1</div>
      <div class="hud-item">ğŸ”¥ <span class="val" id="hudCombo">0</span></div>
    </div>
    <div class="step-dots" id="stepDots"></div>
    <div class="history-row">
      <div class="hist-slot">
        <div class="hist-label" id="lbl2">2 AGO</div>
        <div class="hist-box" id="hist2">?</div>
      </div>
      <div class="hist-slot">
        <div class="hist-label" id="lbl1">1 AGO</div>
        <div class="hist-box" id="hist1">?</div>
      </div>
    </div>
    <div class="compare-hint" id="cmpHint">â†• same as 2 ago? tap MATCH!</div>
    <div class="stage-area">
      <div class="now-label" id="lblNow">NOW â–¼</div>
      <div class="emoji-stage" id="stage">
        <div class="emoji-inner" id="emojiInner"></div>
      </div>
    </div>
    <div class="fb-area"><div class="feedback" id="feedback"></div></div>
    <div class="match-btn-wrap">
      <button class="match-btn" id="matchBtn" disabled>ğŸ¯ MATCH!</button>
    </div>
    <div class="party-crowd" id="partyCrowd"></div>
  </div>
</div>

<div class="screen end-screen" id="scrE">
  <div style="font-size:44px">ğŸ‰ğŸ¥³ğŸŠ</div>
  <div class="end-title" id="txEndT">Party Complete!</div>
  <div class="end-stats" id="eStats"></div>
  <div class="stars-row" id="starsRow"></div>
  <div class="crowd-fin" id="crowdFin"></div>
  <button class="again-btn" id="btnAgain">ğŸµ Party Again!</button>
</div>

<div class="round-overlay" id="roundOv">
  <div class="ro-icon" id="roIcon">ğŸ¶</div>
  <div class="ro-title" id="roTitle"></div>
  <div class="ro-sub" id="roSub"></div>
</div>

<div class="zipp" id="zipp">ğŸ¦Š</div>
<div class="z-bub" id="zBub"></div>
<div class="combo-box" id="cmbB"></div>

<script>
const TX={en:{title:'Echo Echo Party!',sub:'Dancing animals are throwing a party! Tap MATCH when you see an echo â€” the same animal from 2 steps ago!',how:'<b>How to play:</b><br>ğŸ± â†’ ğŸ¶ â†’ ğŸ± â† <b>MATCH!</b> (same as 2 ago)<br>ğŸµ â†’ ğŸ° â†’ ğŸ» â† No match (different)<br>Watch ğŸ‘€ Â· Remember ğŸ§  Â· Tap MATCH! ğŸ¯',start:'ğŸµ Join the Party!',hint:'Tap when NOW = 2 steps ago!',match:'ğŸ¯ MATCH!',round:'Round',twoBack:'2 AGO',oneBack:'1 AGO',now:'NOW â–¼',cmpHint:'â†• same as 2 ago? tap MATCH!',endT:'Party Complete!',again:'ğŸµ Party Again!',correct:['MATCH! ğŸ‰','ECHO! ğŸµ','PERFECT! â­','YES! ğŸ¥³','PARTY! ğŸŠ'],miss:['Missed one! ğŸ˜…','Oops, a match! ğŸ™ˆ','That was it! ğŸ˜'],wrong:['Not quite! ğŸ˜„','Nope! ğŸ«§','Silly tap! ğŸˆ'],great:['Amazing!','Superstar!','Echo hero!','So good!','Wow!','Incredible!'],encourage:['Keep going!','You got this!','Nice rhythm!','Party on!','Stay sharp!'],roundStart:'Find the echoes!',roundDone:'Round Complete!',combo:'COMBO',hits:'Correct Matches',misses:'Missed Matches',wrongs:'Wrong Taps',score:'Score',bestCombo:'Best Combo',friends:'Party Friends',accuracy:'Accuracy',watchTip:'Watch carefully! ğŸ‘€',sameTip:'Same as 2 ago? Tap MATCH!',diffTip:'Different! Just watch ğŸ‘€'},
zh:{title:'å›éŸ³å›éŸ³æ´¾å°ï¼',sub:'è·³èˆçš„å‹•ç‰©æ­£åœ¨é–‹æ´¾å°ï¼ç•¶ç¾åœ¨çš„å‹•ç‰©è·Ÿå…©æ­¥å‰çš„ä¸€æ¨£æ™‚ï¼Œé»æ“Šé…å°ï¼',how:'<b>æ€éº¼ç©ï¼š</b><br>ğŸ± â†’ ğŸ¶ â†’ ğŸ± â† <b>é…å°ï¼</b>ï¼ˆè·Ÿå‰2å€‹ä¸€æ¨£ï¼‰<br>ğŸµ â†’ ğŸ° â†’ ğŸ» â† æ²’æœ‰é…å°ï¼ˆä¸åŒï¼‰<br>è§€å¯Ÿ ğŸ‘€ Â· è¨˜ä½ ğŸ§  Â· é»æ“Šé…å°ï¼ğŸ¯',start:'ğŸµ åŠ å…¥æ´¾å°ï¼',hint:'ç¾åœ¨çš„ = å‰2å€‹æ™‚å°±é»æ“Šï¼',match:'ğŸ¯ é…å°ï¼',round:'å›åˆ',twoBack:'å‰2å€‹',oneBack:'å‰1å€‹',now:'ç¾åœ¨ â–¼',cmpHint:'â†• è·Ÿå‰2å€‹ä¸€æ¨£å—ï¼Ÿé»é…å°ï¼',endT:'æ´¾å°å®Œæˆï¼',again:'ğŸµ å†ä¾†ä¸€æ¬¡ï¼',correct:['é…å°ï¼ğŸ‰','å›éŸ³ï¼ğŸµ','å®Œç¾ï¼â­','è€¶ï¼ğŸ¥³','æ´¾å°ï¼ğŸŠ'],miss:['éŒ¯éäº†ï¼ğŸ˜…','å“å‘€æ˜¯é…å°ï¼ğŸ™ˆ','é‚£å€‹æ˜¯ï¼ğŸ˜'],wrong:['ä¸å°å–”ï¼ğŸ˜„','æ²’æœ‰ï¼ğŸ«§','å‚»å‚»çš„ï¼ğŸˆ'],great:['å¤ªæ£’äº†ï¼','è¶…ç´šå·¨æ˜Ÿï¼','å›éŸ³è‹±é›„ï¼','å¥½å²å®³ï¼','å“‡ï¼','ä¸å¯æ€è­°ï¼'],encourage:['ç¹¼çºŒåŠ æ²¹ï¼','ä½ å¯ä»¥çš„ï¼','å¥½ç¯€å¥ï¼','ç¹¼çºŒæ´¾å°ï¼','ä¿æŒå°ˆæ³¨ï¼'],roundStart:'æ‰¾åˆ°å›éŸ³ï¼',roundDone:'å›åˆå®Œæˆï¼',combo:'é€£æ“Š',hits:'æ­£ç¢ºé…å°',misses:'éŒ¯éé…å°',wrongs:'éŒ¯èª¤é»æ“Š',score:'åˆ†æ•¸',bestCombo:'æœ€ä½³é€£æ“Š',friends:'æ´¾å°æœ‹å‹',accuracy:'æº–ç¢ºç‡',watchTip:'ä»”ç´°çœ‹ï¼ğŸ‘€',sameTip:'è·Ÿå‰2å€‹ä¸€æ¨£ï¼Ÿé»é…å°ï¼',diffTip:'ä¸ä¸€æ¨£ï¼ç¹¼çºŒçœ‹ ğŸ‘€'}};

const ANIMALS=['ğŸ±','ğŸ¶','ğŸµ','ğŸ°','ğŸ»','ğŸ¼','ğŸ¦Š','ğŸ¸','ğŸ¦','ğŸ¯','ğŸ·','ğŸ®'];
const P_COLS=['#ff6b6b','#ffd93d','#6BCB77','#74b9ff','#a55eea','#ff9ff3','#48dbfb','#ff8c00'];
const ROUNDS=[
{length:10,matches:3,interval:2600,animals:5},
{length:12,matches:4,interval:2300,animals:6},
{length:12,matches:4,interval:2000,animals:7},
{length:14,matches:5,interval:1800,animals:8}];

let lang='en',score=0,round=0;
let totalHits=0,totalMisses=0,totalWrongs=0,totalMatches=0;
let combo=0,bestCombo=0;
let phase='idle';
let seq=[],isM=[];
let curIdx=-1,responded=false;
let emojiTO=null,fbTO=null,timerAnim=null,noteInt=null;
let partyList=[];
let tStart=0,tDur=0;

const $=id=>document.getElementById(id);
const tx=k=>(TX[lang]||TX.en)[k]||k;
const pick=a=>a[Math.floor(Math.random()*a.length)];
const rand=(a,b)=>Math.random()*(b-a)+a;

$('langBtn').onclick=e=>{e.stopPropagation();$('langDd').classList.toggle('show')};
$('lEN').onclick=()=>setL('en');$('lZH').onclick=()=>setL('zh');
document.addEventListener('click',e=>{if(!e.target.closest('#langBtn')&&!e.target.closest('#langDd'))$('langDd').classList.remove('show')});

function setL(l){lang=l;$('langDd').classList.remove('show');$('lEN').classList.toggle('sel',l==='en');$('lZH').classList.toggle('sel',l==='zh');updTx()}
function updTx(){$('txTitle').textContent=tx('title');$('txSub').textContent=tx('sub');$('txHow').innerHTML=tx('how');$('btnStart').textContent=tx('start');$('txHint').textContent=tx('hint');$('matchBtn').textContent=tx('match');$('lvV').textContent=tx('round')+' '+(round+1);$('hudRound').textContent=tx('round')+' '+(round+1);$('lbl2').textContent=tx('twoBack');$('lbl1').textContent=tx('oneBack');$('lblNow').textContent=tx('now');$('cmpHint').textContent=tx('cmpHint');$('txEndT').textContent=tx('endT');$('btnAgain').textContent=tx('again')}
function updSc(){$('scV').textContent=score}
function showScr(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active')}

function genSeq(rd){
const pool=ANIMALS.slice(0,rd.animals);
const s=[],m=[];
const pos=[];for(let i=2;i<rd.length;i++)pos.push(i);
for(let i=pos.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pos[i],pos[j]]=[pos[j],pos[i]]}
const mSet=new Set(pos.slice(0,rd.matches));
s.push(pick(pool));
let s2=pick(pool.filter(a=>a!==s[0]));s.push(s2);
m.push(false,false);
for(let i=2;i<rd.length;i++){
if(mSet.has(i)){s.push(s[i-2]);m.push(true)}
else{const ch=pool.filter(a=>a!==s[i-2]);s.push(pick(ch));m.push(false)}}
return{seq:s,isM:m}}

function spawnNote(){const n=document.createElement('div');n.className='m-note';n.textContent=pick(['ğŸµ','ğŸ¶','ğŸ¤','ğŸ¸','ğŸº','ğŸ¥','ğŸ¹','ğŸ·']);n.style.left=rand(5,90)+'%';n.style.bottom=rand(5,30)+'%';n.style.setProperty('--d',rand(3,5).toFixed(1)+'s');n.style.setProperty('--dx',rand(-25,25).toFixed(0)+'px');document.body.appendChild(n);setTimeout(()=>n.remove(),5500)}

function confetti(n){for(let i=0;i<n;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'vw';c.style.top=(Math.random()*6-3)+'vh';const sz=5+Math.random()*8;c.style.width=sz+'px';c.style.height=sz+'px';c.style.background=pick(P_COLS);c.style.borderRadius=Math.random()>.5?'50%':'2px';c.style.animationDelay=(Math.random()*.5)+'s';document.body.appendChild(c);setTimeout(()=>c.remove(),1800)}}

function sparkAt(el,n){const r=el.getBoundingClientRect();const cx=r.left+r.width/2,cy=r.top+r.height/2;const em=['âœ¨','â­','ğŸ’«','ğŸŒŸ'];for(let i=0;i<n;i++){const s=document.createElement('div');s.className='sparkle';s.textContent=pick(em);s.style.left=(cx+rand(-25,25))+'px';s.style.top=(cy+rand(-15,15))+'px';s.style.animationDelay=(i*.08)+'s';document.body.appendChild(s);setTimeout(()=>s.remove(),750)}}

function showFb(text,color){const fb=$('feedback');fb.textContent=text;fb.style.color=color||'#fff';fb.classList.remove('show');void fb.offsetWidth;fb.classList.add('show');clearTimeout(fbTO);fbTO=setTimeout(()=>fb.classList.remove('show'),1100)}
function showCombo(){const e=$('cmbB');e.textContent='ğŸ”¥ '+combo+'x '+tx('combo')+'!';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),1300)}

let zTo;function zSay(t){$('zBub').textContent=t;$('zBub').classList.add('show');clearTimeout(zTo);zTo=setTimeout(()=>$('zBub').classList.remove('show'),2400)}
function zDance(){$('zipp').classList.remove('zDance');void $('zipp').offsetWidth;$('zipp').classList.add('zDance')}

function addCrowd(em){if(partyList.length>=18)return;partyList.push(em);renderCrowd()}
function renderCrowd(){const c=$('partyCrowd');c.innerHTML='';partyList.forEach((em,i)=>{const sp=document.createElement('span');sp.className='crowd-m';sp.textContent=em;sp.style.setProperty('--dl',(i*.12)+'s');c.appendChild(sp)})}
function groupDance(){$('partyCrowd').querySelectorAll('.crowd-m').forEach(m=>{m.classList.remove('cParty');void m.offsetWidth;m.classList.add('cParty')})}

function makeDots(len){const d=$('stepDots');d.innerHTML='';for(let i=0;i<len;i++){const dot=document.createElement('div');dot.className='s-dot';dot.id='dt'+i;d.appendChild(dot)}}
function markDot(i,t){const d=$('dt'+i);if(d){d.classList.remove('cur');d.classList.add(t)}}
function hlDot(i){document.querySelectorAll('.s-dot.cur').forEach(d=>d.classList.remove('cur'));const d=$('dt'+i);if(d)d.classList.add('cur')}

function startTimerBar(dur){tStart=performance.now();tDur=dur;cancelAnimationFrame(timerAnim);function tk(now){const p=Math.max(0,1-(now-tStart)/tDur);$('timerBar').style.width=(p*100)+'%';if(p>0&&phase==='playing')timerAnim=requestAnimationFrame(tk)}timerAnim=requestAnimationFrame(tk)}

function showOv(title,sub,icon,dur){$('roTitle').textContent=title;$('roSub').textContent=sub;$('roIcon').textContent=icon||'ğŸ¶';$('roundOv').classList.add('show');return new Promise(r=>{setTimeout(()=>{$('roundOv').classList.remove('show');r()},dur||1800)})}

function showEmoji(idx){
if(phase!=='playing')return;
curIdx=idx;responded=false;hlDot(idx);
const em=seq[idx];
const inner=$('emojiInner');const stage=$('stage');

if(idx>=2){$('hist2').textContent=seq[idx-2];$('hist2').classList.remove('pop');void $('hist2').offsetWidth;$('hist2').classList.add('pop')}
else $('hist2').textContent='?';
if(idx>=1)$('hist1').textContent=seq[idx-1];
else $('hist1').textContent='?';

inner.textContent=em;inner.className='emoji-inner enter';
setTimeout(()=>{if(phase==='playing'&&curIdx===idx)inner.className='emoji-inner dance'},420);
stage.className='emoji-stage';
$('matchBtn').disabled=(idx<2);

const rd=ROUNDS[round];
startTimerBar(rd.interval);

if(round===0&&idx===0)zSay(tx('watchTip'));
if(round===0&&idx===2){if(isM[idx])zSay(tx('sameTip'));else zSay(tx('diffTip'))}

clearTimeout(emojiTO);
emojiTO=setTimeout(()=>{
if(responded||phase!=='playing')return;
responded=true;$('matchBtn').disabled=true;
cancelAnimationFrame(timerAnim);
if(isM[idx]){
totalMisses++;totalMatches++;combo=0;$('hudCombo').textContent='0';
markDot(idx,'miss');
stage.classList.add('st-miss');
showFb(pick(tx('miss')),'#fbbf24');
if(Math.random()<.6)zSay(pick(tx('encourage')));
setTimeout(()=>{stage.className='emoji-stage';nextStep()},450)}
else{markDot(idx,'skip');nextStep()}
},rd.interval)}

function handleTap(){
if(phase!=='playing'||responded||curIdx<0||curIdx<2)return;
responded=true;$('matchBtn').disabled=true;
clearTimeout(emojiTO);cancelAnimationFrame(timerAnim);
if(isM[curIdx]){
totalHits++;totalMatches++;combo++;if(combo>bestCombo)bestCombo=combo;
const pts=30+round*10+Math.min(combo*10,50);score+=pts;updSc();
$('hudHits').textContent=totalHits;$('hudCombo').textContent=combo;
markDot(curIdx,'hit');
$('stage').classList.add('st-correct');$('emojiInner').className='emoji-inner celebrate';
showFb(pick(tx('correct')),'#4ade80');
sparkAt($('stage'),6);confetti(8);spawnNote();
if(combo>=3){showCombo();groupDance()}
addCrowd(seq[curIdx]);
if(Math.random()<.5)zSay(pick(tx('great')));else zDance();
setTimeout(()=>{$('stage').className='emoji-stage';nextStep()},700)}
else{
totalWrongs++;combo=0;$('hudCombo').textContent='0';
markDot(curIdx,'wrong');
$('stage').classList.add('st-wrong');$('emojiInner').className='emoji-inner shake';
showFb(pick(tx('wrong')),'#f87171');
setTimeout(()=>{$('stage').className='emoji-stage';nextStep()},500)}}

function nextStep(){
if(phase!=='playing')return;
if(curIdx>=ROUNDS[round].length-1){endRound()}
else{showEmoji(curIdx+1)}}

async function endRound(){
if(phase==='gameEnd')return;
phase='roundEnd';clearTimeout(emojiTO);cancelAnimationFrame(timerAnim);
$('matchBtn').disabled=true;
const rd=ROUNDS[round];
const mInRound=isM.filter(Boolean).length;
const hitsThisRound=totalHits;
confetti(6);
await showOv(tx('roundDone')+' ğŸ‰','âœ… '+totalHits+' / '+totalMatches+'  |  ğŸ”¥ '+bestCombo+'x',['ğŸ¶','ğŸµ','ğŸ¤','ğŸ¥'][round]||'ğŸ¶',2000);
if(round<ROUNDS.length-1){round++;startRound()}else{endGame()}}

async function startRound(){
const rd=ROUNDS[round];
$('lvV').textContent=tx('round')+' '+(round+1);
$('hudRound').textContent=tx('round')+' '+(round+1);
updTx();

const g=genSeq(rd);seq=g.seq;isM=g.isM;
makeDots(rd.length);
$('hist2').textContent='?';$('hist1').textContent='?';
$('emojiInner').textContent='';$('timerBar').style.width='100%';
$('feedback').classList.remove('show');

const icons=['ğŸ¶','ğŸµ','ğŸ¤','ğŸ¥'];
const spd=lang==='en'?
(round===0?'Nice & easy!':round===1?'Getting faster!':round===2?'Speeding up!':'Super fast!'):
(round===0?'è¼•é¬†é–‹å§‹ï¼':round===1?'åŠ å¿«é€Ÿåº¦ï¼':round===2?'è¶Šä¾†è¶Šå¿«ï¼':'è¶…ç´šå¿«ï¼');
await showOv(tx('round')+' '+(round+1),tx('roundStart')+'\n'+spd,icons[round]||'ğŸ¶',1900);

phase='playing';showEmoji(0)}

function startGame(){
score=0;round=0;totalHits=0;totalMisses=0;totalWrongs=0;totalMatches=0;combo=0;bestCombo=0;
partyList=[];renderCrowd();updSc();
$('hudHits').textContent='0';$('hudCombo').textContent='0';
showScr('scrG');
clearInterval(noteInt);noteInt=setInterval(()=>{if(phase==='playing')spawnNote()},2800);
startRound()}

function endGame(){
phase='gameEnd';clearTimeout(emojiTO);cancelAnimationFrame(timerAnim);clearInterval(noteInt);
$('matchBtn').disabled=true;
const acc=totalMatches>0?Math.round(totalHits/totalMatches*100):0;
const stars=acc>=85?3:acc>=60?2:acc>=35?1:0;
showScr('scrE');updTx();
$('eStats').innerHTML=
'<div>ğŸ† '+tx('score')+': <span class="v">'+score+'</span></div>'+
'<div>âœ… '+tx('hits')+': <span class="v">'+totalHits+'</span></div>'+
'<div>ğŸ’¨ '+tx('misses')+': <span class="v">'+totalMisses+'</span></div>'+
'<div>âŒ '+tx('wrongs')+': <span class="v">'+totalWrongs+'</span></div>'+
'<div>ğŸ¯ '+tx('accuracy')+': <span class="v">'+acc+'%</span></div>'+
'<div>ğŸ”¥ '+tx('bestCombo')+': <span class="v">'+bestCombo+'</span></div>';
$('starsRow').textContent='â­'.repeat(stars)+'â˜†'.repeat(3-stars);
const cf=$('crowdFin');cf.innerHTML='';
if(partyList.length>0){const lb=document.createElement('div');lb.className='cf-lbl';lb.textContent='ğŸ‰ '+tx('friends')+': '+partyList.length;cf.appendChild(lb);partyList.forEach((em,i)=>{const sp=document.createElement('span');sp.textContent=em;sp.style.animationDelay=(i*.06)+'s';cf.appendChild(sp)})}
confetti(20);zDance();zSay(lang==='en'?'Amazing party! ğŸ‰':'è¶…æ£’çš„æ´¾å°ï¼ğŸ‰')}

$('matchBtn').addEventListener('pointerdown',e=>{e.preventDefault();handleTap()},{passive:false});
document.addEventListener('keydown',e=>{if(e.code==='Space'&&phase==='playing'&&!responded){e.preventDefault();handleTap()}});
$('btnStart').onclick=startGame;
$('btnAgain').onclick=startGame;
setL('en');
</script>
</body>
</html>