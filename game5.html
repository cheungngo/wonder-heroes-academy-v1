<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Dino Train Rescue - Wonder Heroes Academy</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#56CCF2 0%,#4FA8E0 30%,#3D8BC7 55%,#5A9E50 72%,#4A8B40 80%,#3B7232 100%);display:flex;flex-direction:column;height:100vh;height:100dvh;position:relative}

.cloud{position:fixed;pointer-events:none;font-size:36px;opacity:.55;animation:drift var(--d,22s) linear infinite}
@keyframes drift{0%{transform:translateX(-80px)}100%{transform:translateX(calc(100vw + 80px))}}

.top-bar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:6px 10px;z-index:100;flex-shrink:0;position:relative}
.btn-icon{width:42px;height:42px;border-radius:12px;border:2px solid rgba(255,255,255,.3);background:rgba(255,255,255,.18);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;text-decoration:none;transition:transform .15s,background .15s}
.btn-icon:active{transform:scale(.9);background:rgba(255,255,255,.35)}
.top-mid{text-align:center;color:#fff}
.top-mid .sc{font-size:22px;font-weight:900;color:#FFD700;text-shadow:0 2px 8px rgba(0,0,0,.25)}
.top-mid .lv{font-size:11px;opacity:.8}
.lang-dd{position:absolute;top:52px;left:10px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:200;overflow:hidden;display:none}
.lang-dd.show{display:block}
.lang-dd button{padding:12px 20px;font-size:16px;cursor:pointer;border:none;background:#fff;width:100%;text-align:left;display:block}
.lang-dd button:active{background:#e8f5e9}
.lang-dd button.sel{background:#c8e6c9;font-weight:700}

.screen{display:none;width:100%;flex:1;flex-direction:column;align-items:center;overflow:hidden;min-height:0}
.screen.active{display:flex}

.start-screen{justify-content:center;gap:14px;text-align:center;padding:20px}
.g-title{font-size:28px;font-weight:900;color:#fff;line-height:1.2;text-shadow:0 3px 12px rgba(0,0,0,.25)}
.g-sub{color:rgba(255,255,255,.8);font-size:14px;max-width:300px}
.big-icon{font-size:64px;animation:trBob 2.5s ease-in-out infinite}
@keyframes trBob{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-12px) rotate(2deg)}}
.start-btn{padding:16px 36px;font-size:20px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#FF6B6B,#FFD93D,#6BCB77);background-size:300% 300%;animation:gSh 4s ease infinite;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.25);box-shadow:0 6px 25px rgba(0,0,0,.25);transition:transform .15s}
@keyframes gSh{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.start-btn:active{transform:scale(.95)}
.hint-tx{color:rgba(255,255,255,.4);font-size:12px}

.game-wrap{flex:1;width:100%;max-width:420px;display:flex;flex-direction:column;min-height:0;padding:0 6px}
.status-row{display:flex;justify-content:space-between;align-items:center;padding:2px 6px;flex-shrink:0}
.hearts{font-size:20px;letter-spacing:1px}
.dino-saved{font-size:13px;color:#FFD700;font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,.25)}

.stations-row{display:flex;justify-content:space-around;padding:3px 6px;flex-shrink:0;gap:6px}
.station{flex:1;text-align:center;border-radius:14px;padding:5px 2px;border:3px solid rgba(255,255,255,.45);position:relative;transition:transform .2s,box-shadow .3s}
.station .st-icon{font-size:26px}
.station .st-lbl{font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.station.target{transform:scale(1.07);box-shadow:0 0 18px rgba(255,255,255,.55);animation:stP .8s ease infinite}
@keyframes stP{0%,100%{box-shadow:0 0 14px rgba(255,255,255,.4)}50%{box-shadow:0 0 28px rgba(255,255,255,.7)}}
.station.correct-st{animation:stW .5s ease}
@keyframes stW{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
.station.wrong-st{box-shadow:0 0 20px rgba(255,215,0,.8)!important;transition:box-shadow 0s}

.rule-box{flex-shrink:0;padding:2px 6px;min-height:30px;display:flex;align-items:center;justify-content:center}
.rule-text{font-size:13px;font-weight:700;color:#fff;background:rgba(0,0,0,.18);padding:3px 14px;border-radius:18px;text-shadow:0 1px 3px rgba(0,0,0,.25);transition:background .3s}
.rule-text.flash{animation:rFlash .45s ease 3}
@keyframes rFlash{0%,100%{background:rgba(0,0,0,.18)}50%{background:rgba(255,215,0,.5)}}

.track-area{flex:1;position:relative;margin:3px 6px;border-radius:14px;background:linear-gradient(180deg,rgba(50,90,40,.2),rgba(60,100,50,.12));overflow:hidden;min-height:0}
.track-area::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(180deg,transparent 0px,transparent 22px,rgba(139,119,101,.18) 22px,rgba(139,119,101,.18) 26px);pointer-events:none;z-index:0}
.rail{position:absolute;top:0;bottom:0;width:4px;background:#8B7355;transform:translateX(-50%);z-index:1;box-shadow:-4px 0 0 rgba(109,91,71,.35),4px 0 0 rgba(109,91,71,.35)}
.lane-indicator{position:absolute;bottom:6px;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.06);border:2px dashed rgba(255,255,255,.12);transform:translateX(-50%);z-index:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,.2)}

.dino-train{position:absolute;z-index:10;display:flex;flex-direction:column;align-items:center;pointer-events:none;filter:drop-shadow(0 3px 6px rgba(0,0,0,.3))}
.dino-body{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;border:3px solid rgba(255,255,255,.5);position:relative;overflow:hidden}
.dino-body::before{content:'';position:absolute;top:0;left:3px;right:3px;height:40%;background:linear-gradient(180deg,rgba(255,255,255,.3),transparent);border-radius:10px 10px 0 0;pointer-events:none}
.dino-wheels{display:flex;gap:14px;margin-top:-1px}
.dino-wheels span{width:10px;height:10px;border-radius:50%;background:#555;border:2px solid #888}
.dino-train.arrive{animation:dinoArrive .4s ease}
@keyframes dinoArrive{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
.dino-train.wrong-shake{animation:dShake .4s ease}
@keyframes dShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

.controls-row{display:flex;justify-content:space-around;align-items:center;padding:6px 14px;flex-shrink:0;gap:12px}
.arrow-btn{width:68px;height:52px;border-radius:16px;border:3px solid rgba(255,255,255,.35);background:rgba(255,255,255,.18);color:#fff;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .1s,background .1s}
.arrow-btn:active{transform:scale(.88);background:rgba(255,255,255,.4)}
.ctrl-mid{color:rgba(255,255,255,.5);font-size:12px;text-align:center}

.parrot{position:fixed;bottom:68px;left:8px;font-size:32px;z-index:80;pointer-events:none}
.parrot.talk{animation:pTalk .4s ease 2}
@keyframes pTalk{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-12deg) scale(1.2)}75%{transform:rotate(12deg) scale(1.15)}100%{transform:rotate(0) scale(1)}}
.p-bub{position:fixed;bottom:103px;left:6px;background:#fff;border-radius:12px;padding:5px 11px;font-size:11px;font-weight:700;max-width:130px;box-shadow:0 3px 10px rgba(0,0,0,.2);z-index:80;opacity:0;transition:opacity .3s;text-align:center;pointer-events:none}
.p-bub.show{opacity:1}
.p-bub::after{content:'';position:absolute;bottom:-7px;left:16px;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #fff}

.zipp{position:fixed;bottom:8px;right:8px;font-size:30px;z-index:80;pointer-events:none}
.zipp.dance{animation:zD .6s ease}
@keyframes zD{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-15deg) scale(1.2)}50%{transform:rotate(15deg) scale(1.3)}75%{transform:rotate(-8deg) scale(1.15)}100%{transform:rotate(0) scale(1)}}
.z-bub{position:fixed;bottom:42px;right:6px;background:#fff;border-radius:12px;padding:4px 10px;font-size:11px;font-weight:700;max-width:115px;box-shadow:0 3px 10px rgba(0,0,0,.2);z-index:80;opacity:0;transition:opacity .3s;text-align:center;pointer-events:none}
.z-bub.show{opacity:1}
.z-bub::after{content:'';position:absolute;bottom:-7px;right:12px;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #fff}

.sparkle{position:fixed;font-size:16px;z-index:150;pointer-events:none;animation:spUp .7s ease-out forwards}
@keyframes spUp{0%{transform:translateY(0) scale(.3) rotate(0);opacity:1}100%{transform:translateY(-55px) scale(1.1) rotate(180deg);opacity:0}}
.confetti{position:fixed;z-index:200;pointer-events:none;animation:cFall 1.3s ease-out forwards}
@keyframes cFall{0%{transform:translateY(0) rotate(0) scale(1);opacity:1}100%{transform:translateY(55vh) rotate(720deg) scale(.1);opacity:0}}
.sc-pop{position:fixed;font-size:20px;font-weight:900;color:#FFD700;text-shadow:0 2px 8px rgba(0,0,0,.35);z-index:150;pointer-events:none;animation:scFly .8s ease-out forwards}
@keyframes scFly{0%{transform:translateY(0) scale(.5);opacity:1}100%{transform:translateY(-50px) scale(1.1);opacity:0}}
.flash-ov{position:fixed;inset:0;z-index:50;pointer-events:none;opacity:0;transition:opacity .12s}
.round-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);color:#fff;padding:14px 26px;border-radius:18px;font-size:20px;font-weight:900;z-index:300;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.35);pointer-events:none;white-space:nowrap;transition:transform .4s cubic-bezier(.175,.885,.32,1.275)}
.round-msg.show{transform:translate(-50%,-50%) scale(1)}
.msg-good{background:linear-gradient(135deg,#FFD700,#FF6B81,#A55EEA)}
.msg-oops{background:linear-gradient(135deg,#FF6348,#FF4757)}
.msg-lvl{background:linear-gradient(135deg,#6BCB77,#2E86DE,#A55EEA)}
.msg-rule{background:linear-gradient(135deg,#FF9F43,#FFD93D,#6BCB77)}

.combo-box{position:fixed;top:52px;left:50%;transform:translateX(-50%);color:#FFD700;font-size:18px;font-weight:900;text-shadow:0 2px 8px rgba(255,215,0,.5);z-index:80;opacity:0;transition:opacity .3s;pointer-events:none}
.combo-box.show{opacity:1;animation:cbP .35s ease}
@keyframes cbP{0%{transform:translateX(-50%) scale(.5)}50%{transform:translateX(-50%) scale(1.2)}100%{transform:translateX(-50%) scale(1)}}

.ty-pop{position:absolute;z-index:20;font-size:12px;font-weight:700;color:#fff;background:rgba(0,0,0,.35);padding:2px 8px;border-radius:10px;pointer-events:none;animation:tyUp 1s ease-out forwards;white-space:nowrap}
@keyframes tyUp{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-40px);opacity:0}}

.end-screen{justify-content:center;gap:12px;text-align:center;padding:20px}
.end-title{font-size:28px;font-weight:900;color:#FFD700;text-shadow:0 3px 12px rgba(255,215,0,.5)}
.end-stats{color:#fff;font-size:15px;line-height:2.2}
.end-stats .v{color:#FFD700;font-weight:700;font-size:20px}
.stars-r{font-size:34px;letter-spacing:5px}
.again-btn{padding:14px 34px;font-size:18px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#FF6B6B,#FFD93D,#6BCB77);color:#fff;box-shadow:0 4px 15px rgba(0,0,0,.25);transition:transform .15s}
.again-btn:active{transform:scale(.95)}
.dino-collection{display:flex;gap:4px;justify-content:center;flex-wrap:wrap;font-size:24px;padding:4px}

@media(max-height:640px){.station .st-icon{font-size:20px}.station{padding:3px 2px;border-radius:10px}.station .st-lbl{font-size:9px}.dino-body{width:48px;height:48px;font-size:24px;border-radius:12px}.dino-wheels span{width:8px;height:8px}.dino-wheels{gap:10px}.arrow-btn{width:58px;height:44px;font-size:22px}.controls-row{padding:4px 10px}.rule-box{min-height:26px}.rule-text{font-size:11px;padding:2px 10px}}
@media(max-height:530px){.stations-row{padding:1px 4px;gap:3px}.station .st-icon{font-size:16px}.dino-body{width:40px;height:40px;font-size:20px;border-radius:10px}.arrow-btn{width:50px;height:38px;font-size:18px}.controls-row{padding:2px 8px;gap:8px}}
@media(min-height:780px){.dino-body{width:64px;height:64px;font-size:34px}.station .st-icon{font-size:30px}.station{padding:8px 4px}}
</style>
</head>
<body>

<div class="cloud" style="top:3%;--d:24s;animation-delay:0s">‚òÅÔ∏è</div>
<div class="cloud" style="top:10%;--d:30s;animation-delay:7s;font-size:28px">‚òÅÔ∏è</div>
<div class="cloud" style="top:18%;--d:20s;animation-delay:13s;font-size:44px;opacity:.4">‚òÅÔ∏è</div>

<div class="top-bar">
  <button class="btn-icon" id="langBtn">üåê</button>
  <div class="lang-dd" id="langDd">
    <button class="sel" id="lEN">üá∫üá∏ English</button>
    <button id="lZH">üáπüáº ÁπÅÈ´î‰∏≠Êñá</button>
  </div>
  <div class="top-mid">
    <div class="sc" id="scV">0</div>
    <div class="lv" id="lvV">Level 1</div>
  </div>
  <a href="index.html" class="btn-icon">üè†</a>
</div>

<div class="screen start-screen active" id="scrS">
  <div class="big-icon">üöÇü¶ï</div>
  <div class="g-title" id="txTitle">Dino Train Rescue</div>
  <div class="g-sub" id="txSub">Switch the tracks to help dinosaur friends reach the right colored stations!</div>
  <button class="start-btn" id="btnStart" data-tx="start">üöÇ START! ü¶ï</button>
  <div class="hint-tx" id="txHint">Tap arrows or swipe to switch tracks!</div>
</div>

<div class="screen" id="scrG">
  <div class="game-wrap">
    <div class="status-row">
      <div class="hearts" id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div class="dino-saved" id="dinoSaved">ü¶ï 0</div>
    </div>
    <div class="stations-row" id="stRow"></div>
    <div class="rule-box"><div class="rule-text" id="ruleText">üé® Match colors!</div></div>
    <div class="track-area" id="trackArea">
      <div class="dino-train" id="dino" style="display:none">
        <div class="dino-body" id="dinoBody">ü¶ï</div>
        <div class="dino-wheels"><span></span><span></span></div>
      </div>
    </div>
    <div class="controls-row">
      <button class="arrow-btn" id="btnL">‚¨ÖÔ∏è</button>
      <div class="ctrl-mid" id="txSwipe">‚Üê swipe ‚Üí</div>
      <button class="arrow-btn" id="btnR">‚û°Ô∏è</button>
    </div>
  </div>
</div>

<div class="screen end-screen" id="scrE">
  <div style="font-size:52px">üèÜü¶ï</div>
  <div class="end-title" id="txEnd">Amazing!</div>
  <div class="end-stats" id="eStats"></div>
  <div class="stars-r" id="starsR"></div>
  <div class="dino-collection" id="dinoColl"></div>
  <button class="again-btn" id="btnAgain">üöÇ Play Again!</button>
</div>

<div class="parrot" id="parrot">ü¶ú</div>
<div class="p-bub" id="pBub"></div>
<div class="zipp" id="zipp">ü¶ä</div>
<div class="z-bub" id="zBub"></div>
<div class="combo-box" id="cmbB"></div>
<div class="round-msg msg-good" id="mGood"></div>
<div class="round-msg msg-oops" id="mOops"></div>
<div class="round-msg msg-lvl" id="mLvl"></div>
<div class="round-msg msg-rule" id="mRule"></div>
<div class="flash-ov" id="flashO"></div>

<script>
const TX={
en:{title:'Dino Train Rescue',sub:'Switch the tracks to help dinosaur friends reach the right colored stations!',start:'üöÇ START! ü¶ï',hint:'Tap arrows or swipe to switch tracks!',swipe:'‚Üê swipe ‚Üí',matchColor:'üé® Match the colors!',allTo:'üéØ Everyone to {s}!',ready:'Get ready‚Ä¶',perfect:'üéâ Perfect!',great:'‚ú® Great!',oops:'üí´ Wrong station!',lvlup:'‚¨ÜÔ∏è Level Up!',newRule:'üì¢ New Rule!',endT:'Amazing!',score:'Score',level:'Level',saved:'Dinos Saved',best:'Best Streak',again:'üöÇ Play Again!',combo:'COMBO',pizza:'Pizza',slides:'Slides',party:'Party',passengers:'Your Passengers'},
zh:{title:'ÊÅêÈæçÂàóËªäÊïëÊè¥',sub:'ÂàáÊèõËªåÈÅìÂπ´Âä©ÊÅêÈæçÊúãÂèãÂà∞ÈÅîÊ≠£Á¢∫ÁöÑËªäÁ´ôÔºÅ',start:'üöÇ ÈñãÂßãÔºÅü¶ï',hint:'ÈªûÊìäÁÆ≠È†≠ÊàñÊªëÂãï‰æÜÂàáÊèõËªåÈÅìÔºÅ',swipe:'‚Üê ÊªëÂãï ‚Üí',matchColor:'üé® ÈÖçÂ∞çÈ°èËâ≤ÔºÅ',allTo:'üéØ ÂÖ®ÈÉ®Âà∞{s}ÔºÅ',ready:'Ê∫ñÂÇôÂ•Ω‚Ä¶',perfect:'üéâ ÂÆåÁæéÔºÅ',great:'‚ú® ÂæàÂ•ΩÔºÅ',oops:'üí´ ÈåØË™§ËªäÁ´ôÔºÅ',lvlup:'‚¨ÜÔ∏è ÂçáÁ¥ö‰∫ÜÔºÅ',newRule:'üì¢ Êñ∞Ë¶èÂâáÔºÅ',endT:'Â§™Ê£í‰∫ÜÔºÅ',score:'ÂàÜÊï∏',level:'Á≠âÁ¥ö',saved:'ÊãØÊïëÊÅêÈæç',best:'ÊúÄ‰Ω≥ÈÄ£Êìä',again:'üöÇ ÂÜçÁé©‰∏ÄÊ¨°ÔºÅ',combo:'ÈÄ£Êìä',pizza:'Êä´Ëñ©',slides:'ÊªëÊ¢Ø',party:'Ê¥æÂ∞ç',passengers:'‰Ω†ÁöÑ‰πòÂÆ¢'}
};
const STS=[
{color:'#E74C3C',lt:'#ff7675',icon:'üçï',key:'pizza'},
{color:'#2980B9',lt:'#74b9ff',icon:'üé¢',key:'slides'},
{color:'#27AE60',lt:'#55efc4',icon:'üé™',key:'party'}
];
const DINOS=['ü¶ï','ü¶ñ'];
const DINO_NAMES={en:['Rex','Spike','Tiny','Dot','Chomp','Fern','Pebble','Sunny'],zh:['Â∞èÈõ∑','Âà∫Âà∫','Â∞èÂ∞è','ÈªûÈªû','Âí¨Âí¨','Ëï®Ëï®','Áü≥È†≠','Â∞èÈôΩ']};
const ZOK={en:['Nice!','Choo choo!','Great!','Awesome!','Yay!','Cool!','Smart!'],zh:['Ê£íÔºÅ','ÂòüÂòüÔºÅ','ÂæàÂ•ΩÔºÅ','Â§™ËÆö‰∫ÜÔºÅ','ËÄ∂ÔºÅ','ÈÖ∑ÔºÅ','ËÅ∞ÊòéÔºÅ']};
const ZBAD={en:['Almost!','Try again!','So close!','Next time!','You got this!'],zh:['Â∑Æ‰∏ÄÈªûÔºÅ','ÂÜçË©¶Ë©¶ÔºÅ','Â•ΩÊé•ËøëÔºÅ','‰∏ãÊ¨°ÔºÅ','‰Ω†ÂèØ‰ª•ÁöÑÔºÅ']};

let lang='en',score=0,lives=3,level=1;
let dinoLane=1,dinoColorIdx=0,phase='idle';
let totalSaved=0,bestStreak=0,combo=0;
let dinosDelivered=0,nextRuleAt=8,ruleLeft=0;
let curRule={type:'match',target:0};
let speed=0,dinoY=0,animId=null,lastT=0,trkH=0;
let laneX=[],savedDinos=[];

const $=id=>document.getElementById(id);
const tx=k=>(TX[lang]||TX.en)[k]||k;
const pick=a=>a[Math.floor(Math.random()*a.length)];

/* Lang */
$('langBtn').onclick=e=>{e.stopPropagation();$('langDd').classList.toggle('show')};
$('lEN').onclick=()=>setL('en');$('lZH').onclick=()=>setL('zh');
document.addEventListener('click',e=>{if(!e.target.closest('#langBtn')&&!e.target.closest('#langDd'))$('langDd').classList.remove('show')});
function setL(l){lang=l;$('langDd').classList.remove('show');$('lEN').classList.toggle('sel',l==='en');$('lZH').classList.toggle('sel',l==='zh');updTx()}
function updTx(){
$('txTitle').textContent=tx('title');$('txSub').textContent=tx('sub');
$('btnStart').textContent=tx('start');$('txHint').textContent=tx('hint');
$('txSwipe').textContent=tx('swipe');$('txEnd').textContent=tx('endT');
$('btnAgain').textContent=tx('again');$('lvV').textContent=tx('level')+' '+level;
updRuleTx();
document.querySelectorAll('.station').forEach((s,i)=>{const lb=s.querySelector('.st-lbl');if(lb)lb.textContent=tx(STS[i].key)});
}
function updRuleTx(){
if(curRule.type==='match')$('ruleText').textContent=tx('matchColor');
else{const st=STS[curRule.target];$('ruleText').textContent=tx('allTo').replace('{s}',st.icon+' '+tx(st.key))}
}
function updSc(){$('scV').textContent=score;$('lvV').textContent=tx('level')+' '+level}
function updH(){$('hearts').textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives))+'üñ§'.repeat(Math.max(0,3-lives))}
function updSaved(){$('dinoSaved').textContent='ü¶ï '+totalSaved}
function showScr(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active')}

/* Build stations */
function buildStations(){
const r=$('stRow');r.innerHTML='';
STS.forEach((st,i)=>{const d=document.createElement('div');d.className='station';d.style.background=`linear-gradient(135deg,${st.lt},${st.color})`;d.innerHTML=`<div class="st-icon">${st.icon}</div><div class="st-lbl">${tx(st.key)}</div>`;r.appendChild(d)})
}
/* Build rails */
function buildRails(){
const a=$('trackArea');a.querySelectorAll('.rail,.lane-indicator').forEach(e=>e.remove());
for(let i=0;i<3;i++){
const rl=document.createElement('div');rl.className='rail';rl.style.left=((i+.5)/3*100)+'%';a.appendChild(rl);
const li=document.createElement('div');li.className='lane-indicator';li.style.left=((i+.5)/3*100)+'%';li.textContent='‚óè';a.appendChild(li);
}}
function calcPos(){
const a=$('trackArea'),w=a.offsetWidth;trkH=a.offsetHeight;
laneX=[w/6,w/2,w*5/6];
}

/* Target lane */
function targetLane(){return curRule.type==='allTo'?curRule.target:dinoColorIdx}
function hlTarget(){
const t=targetLane();
document.querySelectorAll('.station').forEach((s,i)=>s.classList.toggle('target',i===t))
}

/* Spawn */
function spawnDino(){
if(phase!=='playing')return;
dinoColorIdx=Math.floor(Math.random()*3);
dinoLane=Math.floor(Math.random()*3);
const dn=$('dino'),bd=$('dinoBody'),st=STS[dinoColorIdx];
bd.style.background=`linear-gradient(135deg,${st.lt},${st.color})`;
bd.textContent=pick(DINOS);
dinoY=8;calcPos();
const bw=bd.offsetWidth||56;
dn.style.transition='none';dn.style.left=(laneX[dinoLane]-bw/2)+'px';dn.style.bottom=dinoY+'px';
dn.style.display='flex';dn.style.opacity='1';dn.classList.remove('arrive','wrong-shake');
void dn.offsetWidth;
dn.style.transition='left .25s cubic-bezier(.18,.89,.32,1.28)';
hlTarget();
const tt=Math.max(1.6,3.8-(level-1)*.25);speed=trkH/tt;
lastT=performance.now();animId=requestAnimationFrame(moveDino);
}
function moveDino(ts){
if(phase!=='playing')return;
const dt=(ts-lastT)/1000;lastT=ts;
dinoY+=speed*dt;$('dino').style.bottom=dinoY+'px';
if(dinoY+70>=trkH){checkResult();return}
animId=requestAnimationFrame(moveDino);
}
function switchLane(dir){
if(phase!=='playing')return;
const nl=dinoLane+dir;if(nl<0||nl>2)return;
dinoLane=nl;calcPos();
const bw=$('dinoBody').offsetWidth||56;
$('dino').style.left=(laneX[dinoLane]-bw/2)+'px';
}

/* Check */
function checkResult(){
cancelAnimationFrame(animId);phase='paused';
const tgt=targetLane(),ok=dinoLane===tgt;
const dn=$('dino'),sts=document.querySelectorAll('.station');
sts.forEach(s=>s.classList.remove('target'));

if(ok){
combo++;if(combo>bestStreak)bestStreak=combo;totalSaved++;
const pts=10+level*5+Math.min(combo*3,30);score+=pts;updSc();updSaved();
const stEl=sts[dinoLane];stEl.classList.add('correct-st');setTimeout(()=>stEl.classList.remove('correct-st'),500);
sparkFx(stEl);scPop(stEl,'+'+pts);
dn.classList.add('arrive');
if(combo>=3)showCombo();
zDance();
const dinoEm=pick(DINOS),nm=pick(DINO_NAMES[lang]);
savedDinos.push(dinoEm);
// Thank you popup
const ty=document.createElement('div');ty.className='ty-pop';
ty.textContent=lang==='en'?`${nm}: Thank you! üíï`:`${nm}ÔºöË¨ùË¨ù‰Ω†ÔºÅüíï`;
ty.style.left=$('dino').style.left;ty.style.bottom=(dinoY+60)+'px';
$('trackArea').appendChild(ty);setTimeout(()=>ty.remove(),1100);
if(Math.random()<.4)zSay(pick(ZOK[lang]));
if(totalSaved%2===0)confetti(6);
dinosDelivered++;
if(dinosDelivered%6===0&&level<15){level++;updSc();setTimeout(()=>showMsg('mLvl',tx('lvlup')+' Lv.'+level),350)}
if(ruleLeft>0){ruleLeft--;if(ruleLeft<=0){curRule={type:'match',target:0};updRuleTx();$('ruleText').classList.add('flash');setTimeout(()=>$('ruleText').classList.remove('flash'),1500);parrotSay(tx('matchColor'))}}
else if(dinosDelivered>=nextRuleAt&&level>=3){triggerRule()}
setTimeout(()=>{dn.style.opacity='0';setTimeout(()=>{if(lives>0&&phase==='paused'){phase='playing';spawnDino()}},300)},500);
}else{
lives--;combo=0;updH();flashScr('rgba(255,60,60,.22)');
dn.classList.add('wrong-shake');
showMsg('mOops',tx('oops'));
sts[tgt].classList.add('wrong-st');setTimeout(()=>sts[tgt].classList.remove('wrong-st'),1200);
zSay(pick(ZBAD[lang]));
dinosDelivered++;
if(ruleLeft>0){ruleLeft--;if(ruleLeft<=0){curRule={type:'match',target:0};updRuleTx()}}
setTimeout(()=>{dn.style.opacity='0';setTimeout(()=>{if(lives<=0)endGame();else{phase='playing';spawnDino()}},300)},900);
}
}

function triggerRule(){
const t=Math.floor(Math.random()*3);
curRule={type:'allTo',target:t};ruleLeft=3+Math.floor(Math.random()*3);
nextRuleAt=dinosDelivered+8+Math.floor(Math.random()*5);
updRuleTx();$('ruleText').classList.add('flash');setTimeout(()=>$('ruleText').classList.remove('flash'),1500);
showMsg('mRule',tx('newRule'));parrotSay(tx('newRule'));
}

function startGame(){
score=0;lives=3;level=1;totalSaved=0;bestStreak=0;combo=0;
dinosDelivered=0;nextRuleAt=8;ruleLeft=0;savedDinos=[];
curRule={type:'match',target:0};phase='playing';
updSc();updH();updSaved();updRuleTx();showScr('scrG');
buildStations();buildRails();
zSay(lang==='en'?"Let's go!":"Âá∫ÁôºÂõâÔºÅ");
setTimeout(()=>spawnDino(),700);
}
function endGame(){
phase='idle';cancelAnimationFrame(animId);$('dino').style.display='none';
document.querySelectorAll('.station').forEach(s=>{s.classList.remove('target','correct-st','wrong-st')});
const s=totalSaved>=20?3:totalSaved>=10?2:totalSaved>=3?1:0;
showScr('scrE');
$('eStats').innerHTML=`<div>üèÜ ${tx('score')}: <span class="v">${score}</span></div><div>üìä ${tx('level')}: <span class="v">${level}</span></div><div>ü¶ï ${tx('saved')}: <span class="v">${totalSaved}</span></div><div>üî• ${tx('best')}: <span class="v">${bestStreak}</span></div>`;
$('starsR').textContent='‚≠ê'.repeat(s)+'‚òÜ'.repeat(3-s);
$('dinoColl').innerHTML=savedDinos.length?`<div style="color:rgba(255,255,255,.6);font-size:12px;width:100%">${tx('passengers')}</div>`+savedDinos.slice(-16).map(d=>`<span>${d}</span>`).join(''):'';
confetti(20);zDance();
}

/* Controls */
$('btnStart').onclick=startGame;$('btnAgain').onclick=startGame;
$('btnL').addEventListener('pointerdown',e=>{e.preventDefault();switchLane(-1)});
$('btnR').addEventListener('pointerdown',e=>{e.preventDefault();switchLane(1)});
document.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')switchLane(-1);if(e.key==='ArrowRight')switchLane(1)});

/* Swipe + tap on game screen */
let swX=0,swY=0,swOn=false;
$('scrG').addEventListener('touchstart',e=>{
if(e.target.closest('.arrow-btn')||e.target.closest('.btn-icon'))return;
swX=e.touches[0].clientX;swY=e.touches[0].clientY;swOn=true},{passive:true});
$('scrG').addEventListener('touchmove',e=>{
if(!swOn)return;
const dx=e.touches[0].clientX-swX;
if(Math.abs(dx)>30){switchLane(dx>0?1:-1);swOn=false}
},{passive:true});
$('scrG').addEventListener('touchend',()=>{swOn=false});

/* Tap halves of track area */
$('trackArea').addEventListener('click',e=>{
const r=$('trackArea').getBoundingClientRect(),x=e.clientX-r.left;
if(x<r.width*.35)switchLane(-1);else if(x>r.width*.65)switchLane(1);
});

/* Resize */
window.addEventListener('resize',()=>{
if(phase==='playing'||phase==='paused'){
calcPos();const bw=$('dinoBody').offsetWidth||56;
$('dino').style.transition='none';$('dino').style.left=(laneX[dinoLane]-bw/2)+'px';
void $('dino').offsetWidth;$('dino').style.transition='left .25s cubic-bezier(.18,.89,.32,1.28)';
}});

/* FX */
function sparkFx(el){
const r=el.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
const em=['‚ú®','‚≠ê','üí´','üåü','ü¶ï'];
for(let i=0;i<5;i++){const s=document.createElement('div');s.className='sparkle';s.textContent=pick(em);s.style.left=(cx+(Math.random()-.5)*50)+'px';s.style.top=cy+'px';s.style.animationDelay=i*.06+'s';document.body.appendChild(s);setTimeout(()=>s.remove(),800)}
}
function confetti(n){
const cols=['#ff6b6b','#ffa502','#ffd93d','#2ed573','#1e90ff','#a55eea','#ff9ff3','#ffd700'];
for(let i=0;i<n;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'vw';c.style.top=(Math.random()*12-4)+'vh';const sz=5+Math.random()*8;c.style.width=sz+'px';c.style.height=sz+'px';c.style.background=pick(cols);c.style.borderRadius=Math.random()>.5?'50%':'2px';c.style.animationDelay=Math.random()*.4+'s';document.body.appendChild(c);setTimeout(()=>c.remove(),2e3)}
}
function flashScr(c){const e=$('flashO');e.style.background=c;e.style.opacity='1';setTimeout(()=>e.style.opacity='0',140)}
function scPop(el,t){const r=el.getBoundingClientRect(),p=document.createElement('div');p.className='sc-pop';p.textContent=t;p.style.left=(r.left+r.width/2-18)+'px';p.style.top=r.top+'px';document.body.appendChild(p);setTimeout(()=>p.remove(),900)}
const mTmr={};
function showMsg(id,t){const e=$(id);e.textContent=t;e.classList.add('show');clearTimeout(mTmr[id]);mTmr[id]=setTimeout(()=>e.classList.remove('show'),1100)}
function showCombo(){const e=$('cmbB');e.textContent='üî• '+combo+'x '+tx('combo')+'!';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),1300)}
let zTo;function zSay(t){$('zBub').textContent=t;$('zBub').classList.add('show');clearTimeout(zTo);zTo=setTimeout(()=>$('zBub').classList.remove('show'),1500)}
function zDance(){$('zipp').classList.remove('dance');void $('zipp').offsetWidth;$('zipp').classList.add('dance')}
let pTo;function parrotSay(t){$('pBub').textContent=t;$('pBub').classList.add('show');$('parrot').classList.remove('talk');void $('parrot').offsetWidth;$('parrot').classList.add('talk');clearTimeout(pTo);pTo=setTimeout(()=>$('pBub').classList.remove('show'),2200)}

setL('en');
</script>
</body>
</html>