<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Ocean Treasure Hunt - Wonder Heroes Academy</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#041830 0%,#0a3050 25%,#0c4a6e 50%,#0e6070 75%,#1a5a50 100%);color:#fff;position:relative;height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

.light-rays{position:fixed;top:0;left:0;right:0;height:55%;pointer-events:none;z-index:1;overflow:hidden}
.light-ray{position:absolute;top:-10%;width:55px;height:120%;background:linear-gradient(180deg,rgba(100,200,255,.07),rgba(100,200,255,.02),transparent);transform-origin:top center;animation:rayS var(--d,8s) ease-in-out infinite alternate}
@keyframes rayS{0%{transform:rotate(var(--r1,-5deg)) scaleX(.8)}100%{transform:rotate(var(--r2,5deg)) scaleX(1.2)}}

.ambient-bubble{position:fixed;width:var(--s,8px);height:var(--s,8px);border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.25),rgba(100,200,255,.08));border:1px solid rgba(255,255,255,.08);pointer-events:none;z-index:2;animation:bubUp var(--d,6s) ease-in infinite;animation-delay:var(--dl,0s);left:var(--x,50%);bottom:-20px}
@keyframes bubUp{0%{transform:translateY(0) translateX(0);opacity:.6}25%{transform:translateY(-25vh) translateX(10px)}50%{transform:translateY(-50vh) translateX(-8px);opacity:.4}75%{transform:translateY(-75vh) translateX(12px)}100%{transform:translateY(-105vh) translateX(-5px);opacity:0}}

.sand{position:fixed;bottom:0;left:0;right:0;height:11%;background:linear-gradient(0deg,#c2956a 0%,#a0804e 40%,rgba(90,120,80,.3) 80%,transparent 100%);pointer-events:none;z-index:3}

.top-bar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;z-index:100;position:relative;flex-shrink:0}
.btn-icon{width:42px;height:42px;border-radius:12px;border:2px solid rgba(255,255,255,.12);background:rgba(0,40,80,.45);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;text-decoration:none;transition:transform .15s,background .15s;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.btn-icon:active{transform:scale(.9);background:rgba(0,80,160,.45)}
.top-mid{text-align:center}
.top-mid .sc{font-size:22px;font-weight:900;color:#00d2ff;text-shadow:0 0 14px rgba(0,210,255,.45)}
.top-mid .lv{font-size:11px;color:rgba(255,255,255,.45)}

.lang-dd{position:absolute;top:54px;left:12px;background:rgba(10,40,70,.95);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.6);z-index:200;overflow:hidden;display:none;backdrop-filter:blur(8px)}
.lang-dd.show{display:block}
.lang-dd button{padding:12px 20px;font-size:15px;cursor:pointer;border:none;background:transparent;color:#fff;width:100%;text-align:left}
.lang-dd button:active{background:rgba(255,255,255,.08)}
.lang-dd button.sel{background:rgba(0,210,255,.12);color:#00d2ff;font-weight:700}

.screen{display:none;width:100%;flex:1;flex-direction:column;align-items:center;overflow:hidden;min-height:0;z-index:10}
.screen.active{display:flex}

.start-screen{justify-content:center;gap:16px;text-align:center;padding:24px}
.g-title{font-size:26px;font-weight:900;background:linear-gradient(135deg,#00d2ff,#48dbfb,#FFD700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.3}
.g-sub{color:rgba(255,255,255,.65);font-size:14px;max-width:300px;line-height:1.5}
.big-icon{font-size:56px;animation:swim 3s ease-in-out infinite}
@keyframes swim{0%,100%{transform:translateX(0) rotate(-3deg)}50%{transform:translateX(10px) rotate(3deg)}}
.start-btn{padding:16px 36px;font-size:20px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#00d2ff,#3a7bd5,#00b4d8);background-size:300% 300%;animation:shm 3s ease infinite;color:#fff;box-shadow:0 0 28px rgba(0,180,255,.25);transition:transform .15s}
@keyframes shm{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.start-btn:active{transform:scale(.94)}
.hint-tx{color:rgba(255,255,255,.28);font-size:12px;margin-top:4px}

.game-area{flex:1;width:100%;position:relative;overflow:hidden;min-height:0;z-index:10}
.timer-wrap{position:absolute;top:0;left:0;right:0;height:5px;background:rgba(255,255,255,.06);z-index:50}
.timer-bar{height:100%;background:linear-gradient(90deg,#00d2ff,#3a7bd5,#a855f7);width:100%;border-radius:0 3px 3px 0;box-shadow:0 0 10px rgba(0,180,255,.3);transition:width .25s linear}
.game-hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;z-index:50;pointer-events:none}
.fish-ct{font-size:15px;color:#00d2ff;font-weight:700;text-shadow:0 0 8px rgba(0,180,255,.4);background:rgba(0,20,40,.55);padding:4px 12px;border-radius:20px}
.shell-ct{font-size:14px;color:#FFD700;font-weight:700;text-shadow:0 0 8px rgba(255,215,0,.4);background:rgba(0,20,40,.55);padding:4px 10px;border-radius:20px}

.reef-el{position:absolute;pointer-events:none;z-index:10;font-size:var(--sz,28px);transition:transform .2s}
.reef-el.wiggle{animation:wig .4s ease}
@keyframes wig{0%{transform:rotate(0)}25%{transform:rotate(-10deg)}50%{transform:rotate(10deg)}75%{transform:rotate(-4deg)}100%{transform:rotate(0)}}

.target-fish{position:absolute;z-index:20;cursor:pointer;display:flex;align-items:center;justify-content:center;width:64px;height:64px;border-radius:50%;pointer-events:auto;animation:fishIdle 3.5s ease-in-out infinite}
@keyframes fishIdle{0%,100%{transform:translateY(0) rotate(0)}30%{transform:translateY(-4px) rotate(2deg)}70%{transform:translateY(3px) rotate(-2deg)}}
.target-fish .fish-body{font-size:36px;position:relative;z-index:1}
.target-fish .shades{font-size:13px;position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:2;filter:drop-shadow(0 1px 2px rgba(0,0,0,.6))}
.target-fish .glow-ring{position:absolute;inset:-5px;border-radius:50%;border:2px solid rgba(100,200,255,.2);animation:fGlow 2.5s ease-in-out infinite alternate;pointer-events:none}
@keyframes fGlow{0%{box-shadow:0 0 6px rgba(100,200,255,.12);border-color:rgba(100,200,255,.12)}100%{box-shadow:0 0 16px rgba(100,200,255,.3);border-color:rgba(100,200,255,.3)}}
.target-fish.hint .glow-ring{animation:fGlowH 1s ease-in-out infinite alternate}
@keyframes fGlowH{0%{box-shadow:0 0 10px rgba(255,215,0,.3);border-color:rgba(255,215,0,.35)}100%{box-shadow:0 0 26px rgba(255,215,0,.6);border-color:rgba(255,215,0,.55)}}
.target-fish.found{pointer-events:none;animation:fishDance 1.1s ease forwards}
@keyframes fishDance{0%{transform:rotate(0) scale(1)}12%{transform:rotate(-25deg) scale(1.3)}25%{transform:rotate(25deg) scale(1.4)}38%{transform:rotate(-18deg) scale(1.35)}50%{transform:rotate(18deg) scale(1.3)}65%{transform:rotate(-8deg) scale(1.2)}80%{transform:rotate(5deg) scale(1.1) translateY(-12px)}100%{transform:rotate(0) scale(.9) translateY(-28px);opacity:.2}}

.shell-item{position:absolute;z-index:25;cursor:pointer;font-size:28px;padding:6px;animation:shellBob 2.2s ease-in-out infinite;filter:drop-shadow(0 0 5px rgba(255,215,0,.35));pointer-events:auto}
@keyframes shellBob{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-7px) rotate(5deg)}}
.shell-item.collected{pointer-events:none;animation:shellCol .6s ease forwards}
@keyframes shellCol{0%{transform:scale(1);opacity:1}100%{transform:scale(1.6) translateY(-30px);opacity:0}}

.tap-ripple{position:absolute;z-index:30;width:40px;height:40px;border-radius:50%;border:2px solid rgba(100,200,255,.35);pointer-events:none;animation:tapR .5s ease-out forwards}
@keyframes tapR{0%{transform:translate(-50%,-50%) scale(.3);opacity:1}100%{transform:translate(-50%,-50%) scale(2.2);opacity:0}}

.pop-text{position:absolute;z-index:60;font-weight:800;pointer-events:none;animation:popUp 1.2s ease-out forwards;text-align:center;white-space:nowrap}
@keyframes popUp{0%{transform:translateY(0) scale(.5);opacity:1}60%{opacity:1}100%{transform:translateY(-50px) scale(1);opacity:0}}

.sparkle{position:absolute;z-index:55;font-size:15px;pointer-events:none;animation:spkU .7s ease-out forwards}
@keyframes spkU{0%{transform:translateY(0) scale(.3) rotate(0);opacity:1}100%{transform:translateY(-40px) scale(1) rotate(180deg);opacity:0}}

.confetti{position:fixed;z-index:200;pointer-events:none;animation:cFall 1.6s ease-out forwards}
@keyframes cFall{0%{transform:translateY(0) rotate(0) scale(1);opacity:1}100%{transform:translateY(55vh) rotate(720deg) scale(.06);opacity:0}}

.combo-box{position:fixed;top:52px;left:50%;transform:translateX(-50%);font-size:17px;font-weight:900;color:#00d2ff;text-shadow:0 0 14px rgba(0,210,255,.6);z-index:80;opacity:0;transition:opacity .3s;pointer-events:none}
.combo-box.show{opacity:1;animation:cbPop .35s ease}
@keyframes cbPop{0%{transform:translateX(-50%) scale(.5)}50%{transform:translateX(-50%) scale(1.25)}100%{transform:translateX(-50%) scale(1)}}

.round-overlay{position:fixed;inset:0;z-index:150;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(4,24,48,.88);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);gap:14px;text-align:center;padding:24px}
.round-overlay.show{display:flex}
.ro-title{font-size:28px;font-weight:900;color:#00d2ff;text-shadow:0 0 20px rgba(0,210,255,.5)}
.ro-sub{color:rgba(255,255,255,.7);font-size:16px}
.ro-icon{font-size:50px;animation:swim 2s ease-in-out infinite}

.party-light{position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;z-index:5;animation:pLight 2s ease-in-out infinite alternate;animation-delay:var(--dl,0s)}
@keyframes pLight{0%{opacity:.15;transform:scale(.7)}100%{opacity:.6;transform:scale(1.4)}}

.zipp{position:fixed;bottom:10px;right:10px;font-size:28px;z-index:80;pointer-events:none}
.zipp.dance{animation:zD .6s ease}
@keyframes zD{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-15deg) scale(1.2)}50%{transform:rotate(15deg) scale(1.3)}75%{transform:rotate(-8deg) scale(1.15)}100%{transform:rotate(0) scale(1)}}
.z-bub{position:fixed;bottom:44px;right:8px;background:rgba(255,255,255,.92);color:#333;border-radius:12px;padding:5px 12px;font-size:12px;font-weight:700;max-width:130px;text-align:center;box-shadow:0 3px 14px rgba(0,0,0,.45);z-index:80;opacity:0;transition:opacity .3s;pointer-events:none}
.z-bub.show{opacity:1}
.z-bub::after{content:'';position:absolute;bottom:-7px;right:14px;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid rgba(255,255,255,.92)}

.end-screen{justify-content:center;gap:12px;text-align:center;padding:20px}
.end-title{font-size:26px;font-weight:900;background:linear-gradient(135deg,#00d2ff,#FFD700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.end-stats{color:rgba(255,255,255,.8);font-size:15px;line-height:2.2}
.end-stats .v{color:#00d2ff;font-weight:700;font-size:20px}
.stars-row{font-size:32px;letter-spacing:5px}
.necklace{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px 16px;max-width:320px;width:100%}
.necklace-title{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:8px}
.necklace-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;font-size:22px}
.necklace-row span{animation:nPop .4s ease backwards}
@keyframes nPop{0%{transform:scale(0) rotate(-20deg)}100%{transform:scale(1) rotate(0)}}
.again-btn{padding:14px 34px;font-size:18px;font-weight:700;border:none;border-radius:50px;cursor:pointer;background:linear-gradient(135deg,#00d2ff,#3a7bd5);color:#fff;box-shadow:0 0 22px rgba(0,180,255,.25);transition:transform .15s}
.again-btn:active{transform:scale(.94)}

@media(max-height:640px){.big-icon{font-size:46px}.g-title{font-size:22px}.target-fish{width:56px;height:56px}.target-fish .fish-body{font-size:30px}.target-fish .shades{font-size:11px;top:8px}.necklace-row span{font-size:18px}}
@media(max-height:530px){.target-fish{width:50px;height:50px}.target-fish .fish-body{font-size:26px}.target-fish .shades{font-size:10px;top:7px}}
@media(min-height:800px){.target-fish{width:72px;height:72px}.target-fish .fish-body{font-size:42px}.target-fish .shades{font-size:16px;top:12px}}
</style>
</head>
<body>

<div class="light-rays">
  <div class="light-ray" style="left:8%;--r1:-8deg;--r2:4deg;--d:7s"></div>
  <div class="light-ray" style="left:28%;--r1:-3deg;--r2:6deg;--d:9s;opacity:.7"></div>
  <div class="light-ray" style="left:52%;--r1:-6deg;--r2:3deg;--d:8s;opacity:.5"></div>
  <div class="light-ray" style="left:76%;--r1:-4deg;--r2:7deg;--d:10s;opacity:.55"></div>
</div>
<div class="sand"></div>

<div class="top-bar">
  <button class="btn-icon" id="langBtn">üåê</button>
  <div class="lang-dd" id="langDd">
    <button class="sel" id="lEN">üá∫üá∏ English</button>
    <button id="lZH">üáπüáº ÁπÅÈ´î‰∏≠Êñá</button>
  </div>
  <div class="top-mid">
    <div class="sc" id="scV">0</div>
    <div class="lv" id="lvV">Round 1</div>
  </div>
  <a href="index.html" class="btn-icon">üè†</a>
</div>

<div class="screen start-screen active" id="scrS">
  <div class="big-icon">üê†üï∂Ô∏è</div>
  <div class="g-title" id="txTitle">Ocean Treasure Hunt</div>
  <div class="g-sub" id="txSub">Find the cool fish hiding in the busy reef! They wear sunglasses and love to dance!</div>
  <button class="start-btn" id="btnStart">üîç Start Hunting! üê†</button>
  <div class="hint-tx" id="txHint">Tap fish with sunglasses üï∂Ô∏è ¬∑ Collect seashells üêö</div>
</div>

<div class="screen" id="scrG">
  <div class="game-area" id="gameArea">
    <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
    <div class="game-hud">
      <div class="fish-ct" id="fishCt">üê† 0/3</div>
      <div class="shell-ct" id="shellCt">üêö 0</div>
    </div>
  </div>
</div>

<div class="screen end-screen" id="scrE">
  <div style="font-size:48px">üê†üéâüêü</div>
  <div class="end-title" id="txEndT">Treasure Hunt Complete!</div>
  <div class="end-stats" id="eStats"></div>
  <div class="stars-row" id="starsRow"></div>
  <div class="necklace" id="necklace">
    <div class="necklace-title" id="txNeck">Zipp's Seashell Necklace</div>
    <div class="necklace-row" id="neckRow"></div>
  </div>
  <button class="again-btn" id="btnAgain">üîç Hunt Again!</button>
</div>

<div class="round-overlay" id="roundOv">
  <div class="ro-icon" id="roIcon">üê†</div>
  <div class="ro-title" id="roTitle"></div>
  <div class="ro-sub" id="roSub"></div>
</div>

<div class="zipp" id="zipp">ü¶ä</div>
<div class="z-bub" id="zBub"></div>
<div class="combo-box" id="cmbB"></div>

<script>
const TX={en:{title:'Ocean Treasure Hunt',sub:'Find the cool fish hiding in the busy reef! They wear sunglasses and love to dance!',start:'üîç Start Hunting! üê†',hint:'Tap fish with sunglasses üï∂Ô∏è ¬∑ Collect seashells üêö',round:'Round',fishFound:'Fish Found',score:'Score',shells:'Seashells',bestCombo:'Best Combo',missed:'Missed',endT:'Treasure Hunt Complete!',again:'üîç Hunt Again!',neck:"Zipp's Seashell Necklace",combo:'COMBO',roundStart:'Find {n} hidden fish!',roundDone:'Round Complete! üéâ',timeUp:"Time's Up! ‚è∞",allFound:'All Fish Found! ‚≠ê',nice:['Found one! üéâ','There you are! üëã','Cool shades! üòé','Dance time! üíÉ','Nice find! ‚ú®'],zG:['Great eyes!','Sharp!','Ocean hero!','Amazing!','Wow!','Super find!'],zM:['Keep looking!','They\'re hiding!','Check around!','You got this!'],zH:['Near the coral!','Try the edges!','Check the bottom!','Look carefully!'],ty:['Thanks! üíï','You found me! üòé','Dance time! üíÉ','Yay! üéâ','Party! ü•≥','So cool! ‚ú®']},
zh:{title:'Êµ∑Ê¥ãÂ∞ãÂØ∂Â§ßÂÜíÈö™',sub:'ÊâæÂà∞ËóèÂú®ÂøôÁ¢åÁèäÁëöÁ§Å‰∏≠Êà¥Â§™ÈôΩÁúºÈè°ÁöÑÈÖ∑È≠öÔºÅÁâ†ÂÄëÂñúÊ≠°Ë∑≥ËàûÔºÅ',start:'üîç ÈñãÂßãÂ∞ãÂØ∂ÔºÅüê†',hint:'ÈªûÊìäÊà¥Â§™ÈôΩÁúºÈè°ÁöÑÈ≠ö üï∂Ô∏è ¬∑ Êî∂ÈõÜÊµ∑Ë≤ùÊÆº üêö',round:'ÂõûÂêà',fishFound:'ÊâæÂà∞ÁöÑÈ≠ö',score:'ÂàÜÊï∏',shells:'Êµ∑Ë≤ùÊÆº',bestCombo:'ÊúÄ‰Ω≥ÈÄ£Êìä',missed:'ÈåØÈÅé',endT:'Â∞ãÂØ∂ÂÆåÊàêÔºÅ',again:'üîç ÂÜçÊ¨°Â∞ãÂØ∂ÔºÅ',neck:'ZippÁöÑÊµ∑Ë≤ùÊÆºÈ†ÖÈèà',combo:'ÈÄ£Êìä',roundStart:'ÊâæÂà∞ {n} Ê¢ùÈö±ËóèÁöÑÈ≠öÔºÅ',roundDone:'ÂõûÂêàÂÆåÊàêÔºÅüéâ',timeUp:'ÊôÇÈñìÂà∞ÔºÅ‚è∞',allFound:'ÂÖ®ÈÉ®ÊâæÂà∞ÔºÅ‚≠ê',nice:['ÊâæÂà∞‰∫ÜÔºÅüéâ','‰Ω†Âú®ÈÄôË£°ÔºÅüëã','Â•ΩÈÖ∑ÁöÑÁúºÈè°ÔºÅüòé','Ë∑≥ËàûÊôÇÈñìÔºÅüíÉ','Â•ΩÊ£íÔºÅ‚ú®'],zG:['Â•ΩÁúºÂäõÔºÅ','Â•ΩÂé≤ÂÆ≥ÔºÅ','Êµ∑Ê¥ãËã±ÈõÑÔºÅ','Â§™Ê£í‰∫ÜÔºÅ','ÂìáÔºÅ','Ë∂ÖÁ¥öÁôºÁèæÔºÅ'],zM:['ÁπºÁ∫åÊâæÔºÅ','Áâ†ÂÄëÂú®Ë∫≤ÔºÅ','Âà∞ËôïÁúãÁúãÔºÅ','‰Ω†ÂèØ‰ª•ÁöÑÔºÅ'],zH:['ÁèäÁëöÈôÑËøëÔºÅ','Ë©¶Ë©¶ÈÇäÁ∑£ÔºÅ','ÁúãÁúãÂ∫ïÈÉ®ÔºÅ','‰ªîÁ¥∞ÁúãÔºÅ'],ty:['Ë¨ùË¨ùÔºÅüíï','‰Ω†ÊâæÂà∞Êàë‰∫ÜÔºÅüòé','Ë∑≥ËàûÊôÇÈñìÔºÅüíÉ','ËÄ∂ÔºÅüéâ','Ê¥æÂ∞çÔºÅü•≥','Â•ΩÈÖ∑ÔºÅ‚ú®']}};

const FISH_EM=['üê†','üêü','üê°'];
const DECOR=[
{e:'ü™∏',sz:[28,44]},{e:'üåø',sz:[24,38]},{e:'üêô',sz:[26,34]},{e:'ü¶Ä',sz:[22,28]},
{e:'ü¶ë',sz:[24,30]},{e:'‚≠ê',sz:[18,26]},{e:'ü™®',sz:[24,34]},{e:'ü´ß',sz:[16,22]},
{e:'üéµ',sz:[18,24]},{e:'üé∂',sz:[18,24]},{e:'üêö',sz:[20,28]},{e:'ü¶ê',sz:[20,26]},
{e:'üê°',sz:[22,28]},{e:'üêü',sz:[22,28]},{e:'üê†',sz:[22,28]},{e:'ü¶à',sz:[24,30]},
{e:'üê¢',sz:[24,30]},{e:'üéÄ',sz:[18,24]},{e:'üíé',sz:[18,24]},{e:'üå∫',sz:[20,26]},
{e:'üç¨',sz:[18,22]},{e:'ü¶û',sz:[22,28]},{e:'üê≥',sz:[26,34]},{e:'üé™',sz:[22,28]}];
const SHELL_EM=['üêö','ü¶™','üêö'];
const P_COLS=['#ff6b6b','#ffd93d','#6BCB77','#74b9ff','#a55eea','#ff9ff3','#00d2ff','#ff8c00'];

const ROUNDS=[
{fish:3,time:22,decor:18,hintT:7},
{fish:4,time:24,decor:24,hintT:7},
{fish:5,time:28,decor:30,hintT:6},
{fish:5,time:24,decor:34,hintT:6},
{fish:6,time:30,decor:40,hintT:5}];

let lang='en',score=0,round=0,fishThisRd=0,totalFish=0,totalMissed=0;
let shells=0,combo=0,bestCombo=0,timer=0,timeSinceLast=0;
let hintOn=false,phase='idle',activeFish=[],activeShells=[];
let animId=null,lastT=0,aW=0,aH=0,partyMade=false;

const $=id=>document.getElementById(id);
const tx=k=>(TX[lang]||TX.en)[k]||k;
const pick=a=>a[Math.floor(Math.random()*a.length)];
const rand=(a,b)=>Math.random()*(b-a)+a;
const dist=(x1,y1,x2,y2)=>Math.sqrt((x1-x2)**2+(y1-y2)**2);

$('langBtn').onclick=e=>{e.stopPropagation();$('langDd').classList.toggle('show')};
$('lEN').onclick=()=>setL('en');$('lZH').onclick=()=>setL('zh');
document.addEventListener('click',e=>{if(!e.target.closest('#langBtn')&&!e.target.closest('#langDd'))$('langDd').classList.remove('show')});

function setL(l){lang=l;$('langDd').classList.remove('show');$('lEN').classList.toggle('sel',l==='en');$('lZH').classList.toggle('sel',l==='zh');updTx()}
function updTx(){$('txTitle').textContent=tx('title');$('txSub').textContent=tx('sub');$('btnStart').textContent=tx('start');$('txHint').textContent=tx('hint');$('lvV').textContent=tx('round')+' '+(round+1);$('txEndT').textContent=tx('endT');$('btnAgain').textContent=tx('again');$('txNeck').textContent=tx('neck')}
function updSc(){$('scV').textContent=score}
function updFC(){const rd=ROUNDS[round]||ROUNDS[0];$('fishCt').textContent='üê† '+fishThisRd+'/'+rd.fish}
function updSC(){$('shellCt').textContent='üêö '+shells}
function showScr(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active')}

function makeBubbles(){for(let i=0;i<14;i++){const b=document.createElement('div');b.className='ambient-bubble';const s=4+Math.random()*10;b.style.setProperty('--s',s+'px');b.style.setProperty('--x',Math.random()*100+'%');b.style.setProperty('--d',(5+Math.random()*8).toFixed(1)+'s');b.style.setProperty('--dl',(-Math.random()*10).toFixed(1)+'s');document.body.appendChild(b)}}
makeBubbles();

function makeParty(){if(partyMade)return;partyMade=true;const a=$('gameArea');for(let i=0;i<12;i++){const l=document.createElement('div');l.className='party-light';l.style.left=rand(5,95)+'%';l.style.top=rand(8,88)+'%';l.style.background=pick(P_COLS);l.style.setProperty('--dl',rand(0,3).toFixed(1)+'s');l.style.boxShadow='0 0 8px '+pick(P_COLS);a.appendChild(l)}}

function measure(){const r=$('gameArea');aW=r.offsetWidth;aH=r.offsetHeight}

function clearReef(){$('gameArea').querySelectorAll('.reef-el,.target-fish,.shell-item,.pop-text,.sparkle,.tap-ripple').forEach(e=>e.remove());activeFish=[];activeShells=[]}

function generateReef(){
clearReef();measure();
const rd=ROUNDS[round]||ROUNDS[0];
const mg=30,topMg=42,botMg=aH*.1;
const usableW=aW-mg*2,usableH=aH-topMg-botMg;
const area=$('gameArea');

for(let i=0;i<rd.decor;i++){
const d=pick(DECOR);const el=document.createElement('div');el.className='reef-el';el.textContent=d.e;
const sz=d.sz[0]+Math.random()*(d.sz[1]-d.sz[0]);el.style.setProperty('--sz',sz+'px');el.style.fontSize=sz+'px';
el.style.left=(mg+Math.random()*usableW)+'px';el.style.top=(topMg+Math.random()*usableH)+'px';
if(Math.random()<.3)el.style.opacity=(.35+Math.random()*.35).toFixed(2);
if(Math.random()<.2)el.style.transform='scaleX(-1)';
area.appendChild(el)}

const fishSize=64,fPos=[];
for(let i=0;i<rd.fish;i++){
let x,y,att=0;
do{x=mg+Math.random()*(usableW-fishSize);y=topMg+10+Math.random()*(usableH-fishSize);att++}
while(att<60&&fPos.some(p=>dist(x,y,p.x,p.y)<75));
fPos.push({x,y});

const el=document.createElement('div');el.className='target-fish';
el.style.left=x+'px';el.style.top=y+'px';
el.style.animationDelay=(-rand(0,3)).toFixed(1)+'s';

const glow=document.createElement('div');glow.className='glow-ring';el.appendChild(glow);
const body=document.createElement('div');body.className='fish-body';body.textContent=pick(FISH_EM);el.appendChild(body);
const shd=document.createElement('div');shd.className='shades';shd.textContent='üï∂Ô∏è';el.appendChild(shd);

const fObj={el,x,y,found:false};
el.addEventListener('pointerdown',e=>{e.preventDefault();e.stopPropagation();tapFish(fObj)},{passive:false});
area.appendChild(el);activeFish.push(fObj)}

const sCt=round>=2?2:1;
for(let i=0;i<sCt;i++){
let x,y,att=0;
do{x=mg+Math.random()*(usableW-40);y=topMg+Math.random()*(usableH-40);att++}
while(att<30&&fPos.some(p=>dist(x,y,p.x,p.y)<55));
const el=document.createElement('div');el.className='shell-item';el.textContent=pick(SHELL_EM);
el.style.left=x+'px';el.style.top=y+'px';
const sObj={el,collected:false};
el.addEventListener('pointerdown',e=>{e.preventDefault();e.stopPropagation();tapShell(sObj)},{passive:false});
area.appendChild(el);activeShells.push(sObj)}
}

function tapFish(f){
if(f.found||phase!=='playing')return;
f.found=true;f.el.classList.add('found');
fishThisRd++;combo++;if(combo>bestCombo)bestCombo=combo;totalFish++;
const pts=20+round*10+Math.min(combo*5,40);score+=pts;
timeSinceLast=0;hintOn=false;
activeFish.forEach(af=>{if(!af.found)af.el.classList.remove('hint')});
updSc();updFC();
popTxt(f.x+32,f.y-8,pick(tx('ty')),'#fff',14);
popTxt(f.x+32,f.y+55,'+'+pts,'#FFD700',20);
sparkAt(f.x+32,f.y+32,6);
if(combo>=3)showCombo();
if(Math.random()<.5)zSay(pick(tx('zG')));else zDance();
const rd=ROUNDS[round];
if(fishThisRd>=rd.fish){phase='roundEnd';cancelAnimationFrame(animId);setTimeout(()=>completeRound(true),900)}}

function tapShell(s){
if(s.collected||phase!=='playing')return;
s.collected=true;s.el.classList.add('collected');shells++;score+=15;
updSc();updSC();
const x=parseFloat(s.el.style.left)+14,y=parseFloat(s.el.style.top)-8;
popTxt(x,y,'üêö +15','#FFD700',16);sparkAt(x,y+20,3);
setTimeout(()=>{if(s.el.parentNode)s.el.remove()},700)}

$('gameArea').addEventListener('pointerdown',function(e){
if(phase!=='playing')return;
if(e.target.closest('.target-fish')||e.target.closest('.shell-item'))return;
const rc=$('gameArea').getBoundingClientRect();
const x=e.clientX-rc.left,y=e.clientY-rc.top;
const rip=document.createElement('div');rip.className='tap-ripple';rip.style.left=x+'px';rip.style.top=y+'px';
$('gameArea').appendChild(rip);setTimeout(()=>rip.remove(),550);
$('gameArea').querySelectorAll('.reef-el').forEach(d=>{
const dx=parseFloat(d.style.left)-x,dy=parseFloat(d.style.top)-y;
if(Math.sqrt(dx*dx+dy*dy)<55){d.classList.remove('wiggle');void d.offsetWidth;d.classList.add('wiggle')}})},{passive:true});

function popTxt(x,y,t,c,sz){const p=document.createElement('div');p.className='pop-text';p.textContent=t;p.style.left=x+'px';p.style.top=y+'px';p.style.color=c||'#fff';p.style.fontSize=(sz||14)+'px';p.style.textShadow='0 0 10px '+(c||'#fff');$('gameArea').appendChild(p);setTimeout(()=>p.remove(),1300)}
function sparkAt(cx,cy,n){const em=['‚ú®','‚≠ê','üí´','üåü','ü´ß'];for(let i=0;i<n;i++){const s=document.createElement('div');s.className='sparkle';s.textContent=pick(em);s.style.left=(cx+rand(-28,28))+'px';s.style.top=(cy+rand(-18,18))+'px';s.style.animationDelay=(i*.08)+'s';$('gameArea').appendChild(s);setTimeout(()=>s.remove(),800)}}
function confetti(n){for(let i=0;i<n;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'vw';c.style.top=(Math.random()*8-4)+'vh';const sz=5+Math.random()*8;c.style.width=sz+'px';c.style.height=sz+'px';c.style.background=pick(P_COLS);c.style.borderRadius=Math.random()>.5?'50%':'2px';c.style.animationDelay=(Math.random()*.6)+'s';document.body.appendChild(c);setTimeout(()=>c.remove(),2200)}}
function showCombo(){const e=$('cmbB');e.textContent='üî• '+combo+'x '+tx('combo')+'!';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),1400)}
let zTo;function zSay(t){$('zBub').textContent=t;$('zBub').classList.add('show');clearTimeout(zTo);zTo=setTimeout(()=>$('zBub').classList.remove('show'),2200)}
function zDance(){$('zipp').classList.remove('dance');void $('zipp').offsetWidth;$('zipp').classList.add('dance')}

function showRdOv(title,sub,icon,dur){
$('roTitle').textContent=title;$('roSub').textContent=sub;$('roIcon').textContent=icon||'üê†';
$('roundOv').classList.add('show');
return new Promise(r=>{setTimeout(()=>{$('roundOv').classList.remove('show');r()},dur||1800)})}

function gameLoop(ts){
if(phase!=='playing')return;
const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;
timer-=dt;timeSinceLast+=dt;
const rd=ROUNDS[round];
$('timerBar').style.width=Math.max(0,timer/rd.time*100)+'%';

if(!hintOn&&timeSinceLast>rd.hintT){
hintOn=true;activeFish.forEach(f=>{if(!f.found)f.el.classList.add('hint')});
zSay(pick(tx('zH')))}

if(timer<=0){timer=0;
const un=activeFish.filter(f=>!f.found).length;totalMissed+=un;
phase='roundEnd';cancelAnimationFrame(animId);
setTimeout(()=>completeRound(false),400);return}
animId=requestAnimationFrame(gameLoop)}

async function startGame(){
score=0;round=0;totalFish=0;totalMissed=0;shells=0;combo=0;bestCombo=0;phase='idle';
updSc();updSC();showScr('scrG');makeParty();startRound()}

async function startRound(){
fishThisRd=0;combo=0;timeSinceLast=0;hintOn=false;
const rd=ROUNDS[round];timer=rd.time;
$('lvV').textContent=tx('round')+' '+(round+1);updFC();$('timerBar').style.width='100%';
await showRdOv(tx('round')+' '+(round+1),tx('roundStart').replace('{n}',rd.fish),'üê†üï∂Ô∏è',1800);
generateReef();phase='playing';lastT=performance.now();
animId=requestAnimationFrame(gameLoop);
zSay(lang==='en'?'Find the cool fish! üï∂Ô∏è':'ÊâæÂà∞ÈÖ∑ÈÖ∑ÁöÑÈ≠öÔºÅüï∂Ô∏è')}

async function completeRound(allFound){
if(phase==='gameEnd')return;phase='roundEnd';cancelAnimationFrame(animId);
if(allFound){confetti(14);
const bonus=Math.max(0,Math.floor(timer))*5;score+=bonus;updSc();
await showRdOv(tx('allFound'),bonus>0?(lang==='en'?'Time bonus: +'+bonus:'ÊôÇÈñìÁçéÂãµ: +'+bonus):'','üéâ',2000)}
else{await showRdOv(tx('timeUp'),lang==='en'?fishThisRd+' of '+ROUNDS[round].fish+' found':'ÊâæÂà∞ '+fishThisRd+'/'+ROUNDS[round].fish,'‚è∞',2000)}
if(round<ROUNDS.length-1){round++;startRound()}else{endGame()}}

function endGame(){
phase='gameEnd';cancelAnimationFrame(animId);clearReef();
$('gameArea').querySelectorAll('.party-light').forEach(e=>e.remove());partyMade=false;
const stars=totalFish>=20?3:totalFish>=14?2:totalFish>=7?1:0;
showScr('scrE');
$('eStats').innerHTML=
'<div>üèÜ '+tx('score')+': <span class="v">'+score+'</span></div>'+
'<div>üê† '+tx('fishFound')+': <span class="v">'+totalFish+'</span></div>'+
'<div>üí® '+tx('missed')+': <span class="v">'+totalMissed+'</span></div>'+
'<div>üêö '+tx('shells')+': <span class="v">'+shells+'</span></div>'+
'<div>üî• '+tx('bestCombo')+': <span class="v">'+bestCombo+'</span></div>';
$('starsRow').textContent='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
const nr=$('neckRow');nr.innerHTML='';
if(shells>0){for(let i=0;i<shells;i++){const s=document.createElement('span');s.textContent=pick(SHELL_EM);s.style.animationDelay=(i*.1)+'s';nr.appendChild(s)}$('necklace').style.display='block'}
else $('necklace').style.display='none';
confetti(20);zDance();zSay(lang==='en'?'Great treasure hunt! üéâ':'Â§™Ê£íÁöÑÂ∞ãÂØ∂ÔºÅüéâ')}

$('btnStart').onclick=startGame;$('btnAgain').onclick=startGame;
window.addEventListener('resize',()=>{if(phase==='playing')measure()});
setL('en');
</script>
</body>
</html>